<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]-->
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title></title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width,initial-scale=1.0, user-scalable=no">
        <!-- Place favicon.ico and apple-touch-icon.png in the root directory -->

        <link rel="stylesheet" href="css/normalize.css">
        <link rel="stylesheet" href="js/bootstrap/css/bootstrap.css">
        <link rel="stylesheet" href="css/main.css">

        <link rel="stylesheet" href="css/bootstrap-notify.css">
        <link rel="stylesheet" href="css/alert-bangtidy.css">
        <link href='http://fonts.googleapis.com/css?family=Noto+Sans|Merriweather+Sans|Sintony:400,700|Roboto' rel='stylesheet' type='text/css'>



        <script src="js/vendor/modernizr-2.6.2.min.js"></script>
		    <script src="js/kinetic-v4.5.0.min.js"></script>

    <script defer="defer">
      // globals
      var stage, nodeOrigin, circleLayer, edgeLayer, nodeLayer, currentNode, selected, uiLayer;
      var nodes = [];
      var edges = [];
      var edgeTemp = [];
      var defaultNodeRadius =  23;
      var debug = false;
      var leftHanded = true;
      var currentMode = 1;


      var colors = [];
      colors['blue'] = '#0174DF';
      colors['edge'] = '#888';

      var namesList = new Array(
        "Barney",
        "Jonathon",
        "Myles",
        "Alethia",
        "Tammera",
        "Veola",
        "Meredith",
        "Renee",
        "Grisel",
        "Celestina",
        "Fausto",
        "Eliana",
        "Raymundo",
        "Lyle",
        "Carry",
        "Kittie",
        "Melonie",
        "Elke",
        "Mattie",
        "Kieth",
        "Lourie",
        "Marcie",
        "Trinity",
        "Librada",
        "Lloyd",
        "Pearlie",
        "Velvet",
        "Stephan",
        "Hildegard",
        "Winfred",
        "Tempie",
        "Maybelle",
        "Melynda",
        "Tiera",
        "Lisbeth",
        "Kiera",
        "Gaye",
        "Edra",
        "Karissa",
        "Manda",
        "Ethelene",
        "Michelle",
        "Pamella",
        "Jospeh",
        "Tonette",
        "Maren",
        "Aundrea",
        "Madelene",
        "Epifania",
        "Olive"
        );

      function doNotification(text, style){
        if (debug == true) {
          var selectedStyle = (style != null) ? style : "info";
          $('.top-right').notify({
              message: text,
              type: selectedStyle,
          }).show();
        }

      }

      function drawNewNodeBox() {
        var nodeOrigin = new Kinetic.Circle({
              radius: 50,
              stroke: '#666',
              strokeWidth: 2,
              y: window.innerHeight - 100,
              x: 100,
              // offset: [25, 25]
            });

        nodeOrigin.on('mousedown touchstart', function() {
            var touchPos = (stage.getTouchPosition() != null) ? stage.getTouchPosition() : stage.getMousePosition();
            var x = touchPos.x;
            var y = touchPos.y;
            var created = buildNode(y, x);
            nodeOrigin.moveToBottom();
            nodeOrigin.setListening(false);
            uiLayer.draw();
        });  

        uiLayer.add(nodeOrigin);
        uiLayer.draw();

      }

      function drawConcentricCircles(number, colour) {
        var colour = (colour != null) ? colour : '#666';
        var circleFills;
        var circles;
        var totalHeight = window.innerHeight-(defaultNodeRadius *  2);
        var increment = totalHeight/number;
        var offset = increment;
        var startOpacity = 0.2;
        var opacityIncrement = startOpacity/number; 
        var opacityOffset = opacityIncrement;

        for(i = 0; i < number; i++) {
          var opacity = startOpacity - (i*opacityIncrement);
          var circles = new Kinetic.Circle({
          x: window.innerWidth / 2,
          y: window.innerHeight / 2,
          radius: offset/2,
          stroke: 'white',
          strokeWidth: 0.5,
          opacity: 1
          });

          var circleFills = new Kinetic.Circle({
          x: window.innerWidth / 2,
          y: window.innerHeight / 2,
          radius: offset/2,
          fill: colour,
          strokeWidth: 0.5,
          opacity: opacity
          });          

          offset+=increment;
          opacityOffset+=opacityIncrement;
        circleLayer.add(circles); 
        circleLayer.add(circleFills);  
        }
        
        circleLayer.draw();
      }

      function randomBetween(min,max) {

        return Math.random() * (max - min) + min;

	    }

      function clearGraph() {
        edgeLayer.removeChildren();
        edgeLayer.clear();
        nodeLayer.removeChildren();
        nodeLayer.clear();
        nodes = [];

      }

      function animSelected(toAnimate, animColor) {

        $.each(nodes, function (index, value) {
          // nodes[index].children[0].setStroke(null);
          // nodes[index].children[0].setStrokeWidth(null);
        });

        nodeLayer.draw();

        if (selected != toAnimate) {
          var circle = toAnimate.children[0];
          var angularSpeed = Math.PI / 3;
          circle.setStroke(colors['blue']);
          circle.setStrokeWidth(10);
          var anim = new Kinetic.Animation(function(frame) {
            var angleDiff = frame.timeDiff * angularSpeed / 1000;
            circle.rotate(angleDiff);
          }, nodeLayer);

          // anim.start();

          selected = toAnimate;

          return anim;

        }

      }

      function randomGraph(nodeCount,edgeProbability) {


        doNotification("Creating random graph...");
        for (i=0;i<nodeCount;i++) {
          nodes.push(buildNode());
        }

        $.each(nodes, function (index, value) {
          if (randomBetween(0, 1) < edgeProbability) {

            var randomFriend = Math.round(randomBetween(0,nodes.length-1));


            buildEdge(nodes[index],nodes[randomFriend]);
            // doNotification("Adding edge between "+nodes[index]+" and "+nodes[randomFriend]+".", "success");

          }
        });
      }

      
      function updateEdgePosition(dragNode) {

         if (dragNode != null) {

          $.each(dragNode.attrs.edges, function(index, value) {

                if (value.attrs.from == dragNode) {
                  value.attrs.points[0].y = dragNode.attrs.y;
                  value.attrs.points[0].x = dragNode.attrs.x;
                } else {
                  value.attrs.points[1].y = dragNode.attrs.y;
                  value.attrs.points[1].x = dragNode.attrs.x;

                }

          });

         }

        edgeLayer.draw();
      }

      function changeMode(newMode) {
        if (newMode != null) {
          currentMode = newMode;
          doNotification('Changing mode to: '+newMode, 'info');

          switch(newMode) {
            case 1:
              // position nodes
            break;
            case 2:
              // add edges
              //disable node dragging
              $.each(nodes, function (index, value) {
                nodes[index].attrs.draggable = false;
              });

            break;
            case 3:
              // draw communities
            break;          
            default:
              // error handling
              doNotification('ERROR: Current mode not set correctly.', 'error');

          }

        } else {
          doNotification('ERROR: No new mode specified.', 'error');
        }
      }

      function buildNode(x, y, size, shape, label) {
      	var randomy = (y != null) ? x : Math.round(randomBetween(100,window.innerHeight-100));
      	var randomx = (x != null) ? y : Math.round(randomBetween(100,window.innerWidth-100));
        var nodeLabel = (label != null) ? label : namesList[Math.round(randomBetween(0,namesList.length))];
        var nodeSize = (size != null) ? size : defaultNodeRadius;
        var anchor = new Kinetic.Group({
          id: nodes.length,
          draggable: true,
          y: randomy,
          x: randomx,
          edges: []
        });
        var shape = new Kinetic.Circle({
          dashArray: [15, 3],
          radius: nodeSize,
          // shadowColor: 'white',
          // shadowBlur: 15,
          // shadowOffset: 2,
          // shadowOpacity: 0.5,
          stroke: colors['blue'],
          strokeWidth: 10,
          // offset: [25, 25]
        });

        var label = new Kinetic.Text({
        text: nodeLabel,
        fontSize: 15,
        fontFamily: 'Helvetica',
        fill: colors['blue'],
        offset: [-30,10], //[left/right, up/down]
        });

        anchor.add(shape);
        anchor.add(label);


        doNotification("Putting node at: "+randomx+", "+randomy, "success");

        // add hover styling
        anchor.on('mouseover', function() {
          document.body.style.cursor = 'pointer';
          nodeLayer.draw();
        });
        anchor.on('mouseout', function() {
          document.body.style.cursor = 'default';
          nodeLayer.draw();
          
        });

        anchor.on('mousedown', function(evt) {
          this.moveToTop();
          doNotification('Event: '+evt);
          // switch based on current mode

        switch(currentMode) {
          case 1:
            // position nodes


          break;
          case 2:
            // add edges
            if (edgeTemp.length == 1) {

              if (this == edgeTemp[0]) {
                doNotification('Same node. Ignoring...');
                edgeTemp = [];
              } else {
                doNotification('Selected second node.','info');
                buildEdge(edgeTemp[0],this);
                edgeTemp = [];
              }

            } else {
              doNotification('Selected first node.','info');
              edgeTemp.push(this);
            }
          break;
          case 3:
            // draw communities
          break;          
          default:
            // error handling
            doNotification('ERROR: Current mode not set correctly.', 'error');

        }
            // Animate selected node
            doNotification("Selected node "+this.children[1].attrs.text);
            if (selected != null) {selected.stop(); $.each(nodes, function(index, value) { nodes[index].setStrokeWidth = 0; }); }
            currentNode = this;
            selected = animSelected(this);
            selected.start();

        });      

        anchor.on('dragstart', function() {
          updateEdgePosition(this);
        });  

        anchor.on('dragend', function() {
          updateEdgePosition(this);
          uiLayer.children[0].setListening(true);
          uiLayer.draw();
          currentNode = null;
        });

        nodeLayer.add(anchor);
        nodes.push(anchor);
        anchor.moveToBottom();
        nodeLayer.draw();
        return anchor;
      }

      function buildEdge(from, to) {

        var alreadyExists = false;

        $.each(from.attrs.edges, function(index, value) {
          if (value.attrs.from == to || value.attrs.to == to) {
            alreadyExists = true;
          }
        });

        if (alreadyExists || from === to) {

          doNotification("Edge already exists. Cancelling.", "error");
          return false;

        } else {

          var firstx = from.attrs.x;
          var firsty = from.attrs.y;
          var secondx = to.attrs.x;
          var secondy = to.attrs.y;


          var edge = new Kinetic.Line({
            // dashArray: [10, 10, 00, 10],
            strokeWidth: 2,
            stroke: colors['edge'],
            // opacity: 0.8,
            from: from,
            to: to,
            points: [firstx, firsty, secondx, secondy]
          });

          // add edge reference to both of the nodes involved
          from.attrs.edges.push(edge);
          to.attrs.edges.push(edge);


          edgeLayer.add(edge);
          edgeLayer.draw(); 
          nodeLayer.draw();
          doNotification("Created Edge between "+from.children[1].attrs.text+" and "+to.children[1].attrs.text, "success");
          return true;   

        }
   
      }


      window.onload = function() {
        stage = new Kinetic.Stage({
          container: 'container',
          width: window.innerWidth,
          height: window.innerHeight
        });

        $(document).bind("contextmenu",function(e){
              return false;
       });

        $(".nodebutton").click(function() {
          // $(this).toggleClass('btn-danger');
          changeMode(1);
          buildNode();
        });
        
        $(".edgebutton").click(function() {
          $(this).toggleClass('btn-danger');
          if (currentMode == 2) {
            changeMode(1);
          } else {
            changeMode(2);
          }
          
        });

        $(".communitybutton").click(function() {
          $(this).toggleClass('btn-danger');
          changeMode(3);
        });


        circleLayer = new Kinetic.Layer();
        nodeLayer = new Kinetic.Layer();
        edgeLayer = new Kinetic.Layer();
        uiLayer = new Kinetic.Layer();



        // keep curves in sync with the lines
        nodeLayer.on('beforeDraw', function() {
          if(currentNode != null) {
            updateEdgePosition(currentNode);
          }
          
        });

        stage.add(circleLayer);
        stage.add(edgeLayer);
        stage.add(nodeLayer);
        stage.add(uiLayer);

        updateEdgePosition();

        $('img').on('dragstart', function(event) { event.preventDefault(); });

        // Set up interface
        drawConcentricCircles(4);
        drawNewNodeBox();
        // randomGraph(10,1);


      };

    </script>

</head>
   <body>
        <!--[if lt IE 7]>
            <p class="chromeframe">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> or <a href="http://www.google.com/chromeframe/?redirect=true">activate Google Chrome Frame</a> to improve your experience.</p>
        <![endif]-->

        <!-- Add your site or application content here -->

<!--       <div class="ui arrow-nav arrow-nav-left">
        <span class="pictogram arrows">&#59154;</span>
      </div>  
      
      <div class="ui arrow-nav arrow-nav-right">  
        <span class="pictogram arrows">&#10150;</span>
      </div> -->

      <div class='notifications top-right ui'></div>


      <button class="ui btn btn-primary btn-large nodebutton">
        <span class="pictogram button">&#59136;</span>
      </button>

      <button class="ui btn btn-primary btn-large edgebutton">
        <span class="pictogram button">&#128279;</span>
      </button>

      <button class="ui btn btn-primary btn-large communitybutton" >
        <span class="pictogram button">&#59290;</span>
      </button>
      <div class="ring"></div>



 <div id="container">
    </div>

        <script>window.jQuery || document.write('<script src="js/vendor/jquery-1.9.1.min.js"><\/script>')</script>
        <script src="js/plugins.js"></script>
        <script src="js/main.js"></script>
        <script src="js/bootstrap/js/bootstrap.js"></script>
        <script src="js/bootstrap-notify.js"></script>

    </body>
</html>
