// App declaration
var NetworkCanvas=function(e){var t=function(e,t){b.debug&&console.log(e)},n=function(e,t){return Math.random()*(t-e)+e};Storage.prototype.setObject=function(e,t){this.setItem(e,JSON.stringify(t))};Storage.prototype.getObject=function(e){var t=this.getItem(e);return t&&JSON.parse(t)};var r,s,o,u,a,f,l,c,h,p=[],d=!1,v=this,m=[],g=[];g.blue="#0174DF";g.edge="#0174DF";var y={debug:!0,defaultNodeRadius:18,circleColor:"#ff0000",circleNumber:5},b=e||y,w=new Array("Barney","Jonathon","Myles","Alethia","Tammera","Veola","Meredith","Renee","Grisel","Celestina","Fausto","Eliana","Raymundo","Lyle","Carry","Kittie","Melonie","Elke","Mattie","Kieth","Lourie","Marcie","Trinity","Librada","Lloyd","Pearlie","Velvet","Stephan","Hildegard","Winfred","Tempie","Maybelle","Melynda","Tiera","Lisbeth","Kiera","Gaye","Edra","Karissa","Manda","Ethelene","Michelle","Pamella","Jospeh","Tonette","Maren","Aundrea","Madelene","Epifania","Olive");this.init=function(){v.initKinetic();v.drawUIComponents();v.loadGraph()};this.addNode=function(e,r,i,s){var o,f,l=s!=null?s:w[Math.round(n(0,w.length-1))],c=r!=null?r:b.defaultNodeRadius;if(e!=null){o=e[0];f=e[1]}else{o=Math.round(n(100,window.innerWidth-100));f=Math.round(n(100,window.innerHeight-100))}var h=new Kinetic.Group({id:p.length,y:f,x:o,name:l,edges:[],draggable:!0,dragDistance:10}),d=new Kinetic.Circle({radius:c,fill:g.blue,strokeWidth:0}),y=new Kinetic.Text({text:l,fontSize:25,fontFamily:"Lato",fill:"white",offsetX:-32,offsetY:15,fontStyle:100});h.add(d);h.add(y);t("Putting node "+l+" at coordinates x:"+o+", y:"+f,"success");h.on("dragstart",function(){t("dragstart");var e=this;this.moveToTop();a.draw()});h.on("dragmove",function(e){t("Dragmove");var n=this;$.each(u.children,function(e,t){if(t.attrs.from==n||t.attrs.to==n){var r=[t.attrs.from.attrs.x,t.attrs.from.attrs.y,t.attrs.to.attrs.x,t.attrs.to.attrs.y];t.attrs.points=r}});u.draw()});h.on("tap click",function(e){this.moveToTop();a.draw()});h.on("dbltap dblclick",function(e){t("double tap");m.push(this);if(m.length==2){v.addEdge(m[0],m[1]);m[0].children[0].fill(g.blue);m[1].children[0].fill(g.blue);m=[];a.draw()}else{this.children[0].fill("red");a.draw()}});h.on("dragend",function(){t("dragend");var e=this;v.saveGraph()});a.add(h);p.push(h);h.moveToBottom();a.draw();v.saveGraph();return h};this.getNodeByID=function(e){var t={};$.each(p,function(n,r){r.attrs.id==e&&(t=r)});return t};this.addEdge=function(e,n){var r=!1,i,s,o;if(e!=null&&typeof e=="object"||n!=null&&typeof n=="object"){i=e;s=n}else{i=this.getNodeByID(e);s=this.getNodeByID(n)}u.children.length>0&&$.each(u.children,function(e,t){if(t.attrs.from==i&&t.attrs.to==s||t.attrs.to==i&&t.attrs.from==s){o=t;r=!0}});if(r){this.removeEdge(o);return!1}var f=[i.attrs.x,i.attrs.y,s.attrs.x,s.attrs.y],l=new Kinetic.Line({strokeWidth:4,stroke:g.edge,from:i,to:s,points:f});u.add(l);u.draw();a.draw();t("Created Edge between "+i.children[1].attrs.text+" and "+s.children[1].attrs.text,"success");v.saveGraph();return!0};this.removeEdge=function(e){t("Removing edge.");$.each(u.children,function(t,n){if(n==e){u.children[t].remove();u.draw()}});this.saveGraph()};this.getSimpleEdges=function(){var e={},t=0;$.each(u.children,function(n,r){e[t]={};e[t].from=r.attrs.from.attrs.id;e[t].to=r.attrs.to.attrs.id;t++});return e};this.getEdgeLayer=function(){return u};this.initKinetic=function(){r=new Kinetic.Stage({container:"kineticCanvas",width:window.innerWidth,height:window.innerHeight});o=new Kinetic.Layer;a=new Kinetic.Layer;u=new Kinetic.Layer;c=new Kinetic.Layer;r.add(o);r.add(u);r.add(a);r.add(c)};this.loadGraph=function(){t("Loading graph from localStorage.");loadedNodes=localStorage.getObject("nodes");loadedEdges=localStorage.getObject("edges");$.each(loadedNodes,function(e,t){var n=[];n.push(t.x);n.push(t.y);var r=t.name;v.addNode(n,null,null,r)});$.each(loadedEdges,function(e,t){v.addEdge(t.from,t.to)})};this.saveGraph=function(){t("Saving graph.");simpleNodes=v.getSimpleNodes();simpleEdges=v.getSimpleEdges();localStorage.setObject("nodes",simpleNodes);localStorage.setObject("edges",simpleEdges)};this.getNodes=function(){return p};this.getEdges=function(){return u.children};this.getSimpleNodes=function(){var e=new Object;$.each(p,function(t,n){e[n.attrs.id]={};e[n.attrs.id].x=n.attrs.x;e[n.attrs.id].y=n.attrs.y;e[n.attrs.id].name=n.attrs.name});return e};this.drawUIComponents=function(){var e,n,s=b.circleColor,u=window.innerHeight-b.defaultNodeRadius*2,a=.1;for(i=0;i<b.circleNumber;i++){var f=1-i/b.circleNumber,l=u/2*f,n=new Kinetic.Circle({x:window.innerWidth/2,y:window.innerHeight/2,radius:l,stroke:"white",strokeWidth:1.5,opacity:0}),e=new Kinetic.Circle({x:window.innerWidth/2,y:window.innerHeight/2,radius:l,fill:s,opacity:a,strokeWidth:0});a+=(.3-a)/b.circleNumber;o.add(e);o.add(n)}var h=new Kinetic.Circle({radius:50,stroke:"#666",strokeWidth:0,y:window.innerHeight-100,x:100});h.on("click tap",function(){var e=r.getPointerPosition(),n=new Array;n[0]=e.x;n[1]=e.y;t(n);var i=v.addNode(n);h.moveToBottom();c.draw()});c.add(h);o.draw();c.draw()};this.clearGraph=function(){u.removeChildren();u.clear();a.removeChildren();a.clear();p=[];v.saveGraph()};this.createRandomGraph=function(e,r){e=e||10;r=r||.4;t("Creating random graph...");for(i=0;i<e;i++){var s=i+1;t("Adding node "+s+" of "+e);v.addNode()}t("Adding edges.");$.each(p,function(e,t){if(n(0,1)<r){var i=Math.round(n(0,p.length-1));v.addEdge(p[e],p[i])}})};v.init()};