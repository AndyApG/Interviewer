"use strict";var altCanvas=function e(t){function n(e,t,n){for(;1.1*e.width()<t.width()-2*n;)e.fontSize(1.1*e.fontSize()),e.y((t.height()-e.height())/2);e.setX(t.getX()-e.getWidth()/2),e.setY(t.getY()-e.getHeight()/1.8)}function o(e){console.log(e);var t=new Kinetic.Tween({node:e.children[0],duration:.3,fillRed:232,fillGreen:86,fillBlue:87,strokeWidth:10,easing:Kinetic.Easings.EaseInOut,onFinish:function(){setTimeout(function(){var t=new Kinetic.Tween({node:e.children[0],duration:15,fillRed:1,fillGreen:0,fillBlue:0,strokeWidth:4,easing:Kinetic.Easings.EaseInOut});t.play()},5e3)}}),n=new Kinetic.Tween({node:e,duration:.3,scaleX:1.5,scaleY:1.5,easing:Kinetic.Easings.EaseInOut,onFinish:function(){setTimeout(function(){var t=new Kinetic.Tween({node:e,duration:15,scaleX:1,scaleY:1,easing:Kinetic.Easings.EaseInOut});t.play()},5e3)}});t.play(),n.play()}function i(e){console.log(e),console.log("energise node");var t;t=setInterval(function(){if(m===!0){if(e.attrs.energy>=y){e.attrs.energy=e.attrs.energy-1,E=360/e.attrs.energy;var n=new Kinetic.Animation(function(t){var n=(p-e.attrs.energy)/(p-y),o=tinycolor.mix("#221100","#ffe655",100*n);e.children[0].fill(o),e.children[0].stroke(o);var i=k/2;e.children[0].strokeWidth(i*n*Math.sin(2*t.time*Math.PI/(4e3*(1-n)))+i*n+5)},s);n.start()}}else clearInterval(t)},100)}var r,d,a,s,c,l={},g,f=[],w,u=!1,v=!1,h=!1,m=!1,p=60,y=35,k=20,E=360/p,b={blue:"#0174DF",placidblue:"#83b5dd",violettulip:"#9B90C8",hemlock:"#9eccb3",paloma:"#aab1b0",freesia:"#ffd600",cayenne:"#c40000",celosiaorange:"#f47d44",sand:"#ceb48d",dazzlingblue:"#006bb6",edge:"#e85657",selected:"gold"},C={defaultNodeSize:35,defaultNodeColor:b.blue,defaultEdgeColor:b.edge,concentricCircleColor:"#ffffff",concentricCircleNumber:4,criteria:{from:network.getNodes({type_t0:"Ego"})[0].id},nodeTypes:[{name:"Person",color:b.blue},{name:"OnlinePerson",color:b.hemlock},{name:"Organisation",color:b.cayenne},{name:"Professional",color:b.violettulip}]},N=function(e){l.addNode(e.detail)},K=function(e){"undefined"!=typeof e.detail.from&&e.detail.from!==network.getNodes({type_t0:"Ego"})[0].id&&l.addEdge(e.detail)},T=function(e){l.removeNode(e.detail)},x=function(e){l.removeEdge(e.detail)},S=function(){var e=$(".info-button").offset(),t=$(".canvas-title").offset();$(".canvas-title").data("oldPos",t),$(".canvas-title").css({position:"absolute"}),$(".canvas-title").offset(t),$(".canvas-title").children().hide(),$(".canvas-title").addClass("closed"),$(".canvas-title").offset(e),setTimeout(function(){$(".canvas-popover").hide(),$(".info-button").css("visibility","visible")},500)},D=function(){$(".info-button").css("visibility","hidden"),$(".canvas-popover").show(),$(".canvas-title").offset($(".canvas-title").data("oldPos")),$(".canvas-title").removeClass("closed"),setTimeout(function(){$(".canvas-title").children().show()},500)},P=function(e){if(!v&&(u||($(".new-node-form").addClass("node-form-open"),$(".content").addClass("blurry"),u=!0,$(".name-box").focus()),8!==e.which||$(e.target).is("input, textarea, div")||e.preventDefault(),13===event.which)){$(".new-node-form").removeClass("node-form-open"),$(".content").removeClass("blurry"),u=!1;var t={label:$(".name-box").val()};network.addNode(t),$(".name-box").val("")}},W=function(){l.destroy()};return l.init=function(){notify("altCanvas initialising.",1),extend(C,t),$('<div class="canvas-title"><h3>'+C.heading+'</h3><p class="lead">'+C.subheading+"</p></div>").insertBefore("#kineticCanvas"),l.initKinetic(),window.addEventListener("nodeAdded",N,!1),window.addEventListener("edgeAdded",K,!1),window.addEventListener("nodeRemoved",T,!1),window.addEventListener("edgeRemoved",x,!1),window.addEventListener("changeStageStart",W,!1),$(".close-popover").on("click",S),$(".info-button").on("click",D);for(var e=network.getEdges(C.criteria),n=0;n<e.length;n++){var o=network.getEdges({from:e[n].from,to:e[n].to,type:"Dyad"})[0],i=l.addNode(o);if("Select"===C.mode)if(C.variable){var r={from:network.getNodes({type_t0:"Ego"})[0].id,to:e[n].to};r[C.variable]=1,network.getEdges(r).length>0&&(i.children[0].stroke(b.selected),s.draw())}else network.getEdges({from:network.getNodes({type_t0:"Ego"})[0].id,to:e[n].to,type:C.edgeType}).length>0&&(i.children[0].stroke(b.selected),s.draw())}setTimeout(function(){l.drawUIComponents()},0);var d,a;"Edge"===C.mode?(a={type:C.edgeType},d=network.getEdges(a,function(e){var t=[];return $.each(e,function(e,n){n.from!==network.getNodes({type_t0:"Ego"})[0].id&&n.to!==network.getNodes({type_t0:"Ego"})[0].id&&t.push(n)}),t}),$.each(d,function(e,t){l.addEdge(t)})):"Select"===C.mode||"Narrative"===C.mode||"Energy"===C.mode?(a={},a=C.showEdge?{type:C.showEdge}:{type:"Dyad"},d=network.getEdges(a,function(e){var t=[];return $.each(e,function(e,n){n.from!==network.getNodes({type_t0:"Ego"})[0].id&&n.to!==network.getNodes({type_t0:"Ego"})[0].id&&t.push(n)}),t}),$.each(d,function(e,t){l.addEdge(t)})):"Position"===C.mode},l.destroy=function(){$(".new-node-form").remove(),window.removeEventListener("nodeAdded",N,!1),window.removeEventListener("edgeAdded",K,!1),window.removeEventListener("nodeRemoved",T,!1),window.removeEventListener("edgeRemoved",x,!1),window.removeEventListener("changeStageStart",W,!1),$(document).off("keypress",P),$(".close-popover").off("click",S),$(".info-button").off("click",D)},l.resetPositions=function(){for(var e=network.getEdges({from:network.getNodes({type_t0:"Ego"})[0].id,type:"Dyad"}),t=0;t<e.length;t++)network.updateEdge(e[t].id,{coords:[]})},l.addNode=function(e){notify("altCanvas is creating a node.",2);for(var t,r=0;network.getNode(r)!==!1;)r++;var d=!1;("Position"===C.mode||"Edge"===C.mode)&&(d=!0),e.label=e.nname_t0;var c={coords:[$(window).width()+50,100],id:r,label:"Undefined",size:C.defaultNodeSize,strokeWidth:4,energy:p,draggable:d,dragDistance:20};extend(c,e),c.id=parseInt(c.id,10),c.type="Person",c.x=c.coords[0],c.y=c.coords[1];var u=new Kinetic.Group(c);switch(c.type){case"Person":t=new Kinetic.Circle({radius:c.size,fillRed:1,fillGreen:0,fillBlue:0,stroke:"white",strokeWidth:c.strokeWidth});break;case"Organisation":t=new Kinetic.Rect({width:2*c.size,height:2*c.size,fill:c.color,stroke:l.calculateStrokeColor(c.color),strokeWidth:c.strokeWidth});break;case"OnlinePerson":t=new Kinetic.RegularPolygon({sides:3,fill:c.color,radius:1.2*c.size,stroke:l.calculateStrokeColor(c.color),strokeWidth:c.strokeWidth});break;case"Professional":t=new Kinetic.Star({numPoints:6,fill:c.color,innerRadius:c.size-c.size/3,outerRadius:c.size+c.size/3,stroke:l.calculateStrokeColor(c.color),strokeWidth:c.strokeWidth})}var v=new Kinetic.Text({text:c.label,fontFamily:"Lato",fill:"white",align:"center",fontStyle:500});if(notify("Putting node "+c.label+" at coordinates x:"+c.coords[0]+", y:"+c.coords[1],2),u.on("dragstart",function(){if(h===!1){var e={stage:session.currentStage(),timestamp:new Date};w=new CustomEvent("log",{detail:{eventType:"taskComprehended",eventObject:e}}),window.dispatchEvent(w),h=!0}notify("dragstart",1),this.attrs.oldx=this.attrs.x,this.attrs.oldy=this.attrs.y,this.moveToTop(),s.draw()}),u.on("dragmove",function(){if(h===!1){var e={stage:session.currentStage(),timestamp:new Date};w=new CustomEvent("log",{detail:{eventType:"taskComprehended",eventObject:e}}),window.dispatchEvent(w),h=!0}notify("Dragmove",0);var t=c.id;$.each(a.children,function(e,n){if(n.attrs.from.id===t||n.attrs.to.id===t){var o=[l.getNodeByID(n.attrs.from.id).getX(),l.getNodeByID(n.attrs.from.id).getY(),l.getNodeByID(n.attrs.to.id).getX(),l.getNodeByID(n.attrs.to.id).getY()];n.attrs.points=o}}),a.draw()}),u.on("touchstart",function(){console.log("touchstart"),m=!0,"Energy"===C.mode&&i(this)}),u.on("touchend",function(){console.log("touchend"),m=!1,"Energy"===C.mode}),u.on("tap click",function(){if(console.log("tap"),h===!1){var e={stage:session.currentStage(),timestamp:new Date};w=new CustomEvent("log",{detail:{eventType:"taskComprehended",eventObject:e}}),window.dispatchEvent(w),h=!0}w=new CustomEvent("log",{detail:{eventType:"nodeClick",eventObject:this.attrs.id}});var t=this;if(window.dispatchEvent(w),"Select"===C.mode){var n;if(C.variable){var i={},r=network.getEdge(t.attrs.id)[C.variable];0===r||"undefined"==typeof r?(i[C.variable]=1,t.children[0].stroke(b.selected)):(i[C.variable]=0,t.children[0].stroke("white")),network.setProperties(network.getEdge(t.attrs.id),i)}else network.getEdges({type:C.edgeType,from:network.getNodes({type_t0:"Ego"})[0].id,to:this.attrs.to}).length>0?(this.children[0].stroke("white"),network.removeEdge(network.getEdges({type:C.edgeType,from:network.getNodes({type_t0:"Ego"})[0].id,to:this.attrs.to})[0])):(n={from:network.getNodes({type_t0:"Ego"})[0].id,to:this.attrs.to,type:C.edgeType},"undefined"!=typeof C.variables&&$.each(C.variables,function(e,t){n[t.label]=t.value}),this.children[0].stroke(b.selected),network.addEdge(n))}else if("Edge"===C.mode){if(f[0]===this)return!1;if(f.push(this),2===f.length){f[1].children[0].stroke("white"),f[0].children[0].stroke("white");var d={from:f[0].attrs.to,to:f[1].attrs.to,type:C.edgeType};d[C.variables[0]]="perceived",network.addEdge(d)===!1&&(notify("altCanvas removing edge.",2),network.removeEdge(network.getEdges(d))),f=[],s.draw()}else this.children[0].stroke(b.selected),s.draw()}else"Narrative"===C.mode&&o(this);this.moveToTop(),s.draw()}),u.on("dbltap dblclick",function(){if(h===!1){var e={stage:session.currentStage(),timestamp:new Date};w=new CustomEvent("log",{detail:{eventType:"taskComprehended",eventObject:e}}),window.dispatchEvent(w),h=!0}"Edge"===C.mode&&(notify("double tap",1),g=this)}),u.on("dragend",function(){notify("dragend",1);var e={},t={};e.x=this.attrs.oldx,e.y=this.attrs.oldy,t.x=this.attrs.x,t.y=this.attrs.y;var n={from:e,to:t},o=this;w=new CustomEvent("log",{detail:{eventType:"nodeMove",eventObject:n}}),window.dispatchEvent(w),network.setProperties(network.getEdge(o.attrs.id),{coords:[o.attrs.x,o.attrs.y]}),delete this.attrs.oldx,delete this.attrs.oldy}),n(v,t,10),u.add(t),u.add(v),s.add(u),setTimeout(function(){s.draw()},0),!e.coords||0===e.coords.length){var y=new Kinetic.Tween({node:u,x:$(window).width()-150,y:100,duration:.7,easing:Kinetic.Easings.EaseOut});y.play(),network.setProperties(network.getNode(c.id),{coords:[$(window).width()-150,100]})}return u},l.addEdge=function(e){notify("altCanvas is adding an edge.",2);var t=network.getEdges({from:network.getNodes({type_t0:"Ego"})[0].id,to:e.to,type:"Dyad"})[0],n=network.getEdges({from:network.getNodes({type_t0:"Ego"})[0].id,to:e.from,type:"Dyad"})[0],o=[n.coords[0],n.coords[1],t.coords[0],t.coords[1]],i=new Kinetic.Line({strokeWidth:4,opacity:1,stroke:C.defaultEdgeColor,from:n,to:t,points:o});return a.add(i),setTimeout(function(){a.draw()},0),s.draw(),notify("Created Edge between "+n.label+" and "+t.label,"success",2),!0},l.removeEdge=function(e){var t=network.getEdges({from:network.getNodes({type_t0:"Ego"})[0].id,to:e.to,type:"Dyad"})[0],n=network.getEdges({from:network.getNodes({type_t0:"Ego"})[0].id,to:e.from,type:"Dyad"})[0];notify("Removing edge."),$.each(l.getKineticEdges(),function(e,o){(o.attrs.from===n&&o.attrs.to===t||o.attrs.from===t&&o.attrs.to===n)&&(a.children[e].remove(),a.draw())})},l.clearGraph=function(){a.removeChildren(),a.clear(),s.removeChildren(),s.clear()},l.initKinetic=function(){r=new Kinetic.Stage({container:"kineticCanvas",width:window.innerWidth,height:window.innerHeight}),d=new Kinetic.Layer,s=new Kinetic.Layer,a=new Kinetic.Layer,c=new Kinetic.Layer,r.add(d),r.add(a),r.add(s),r.add(c),notify("Kinetic stage initialised.",1)},l.drawUIComponents=function(){for(var e,t,n=C.concentricCircleColor,o=window.innerHeight-C.defaultNodeSize,i=.1,r=0;r<C.concentricCircleNumber;r++){var a=1-r/C.concentricCircleNumber,s=o/2*a;t=new Kinetic.Circle({x:window.innerWidth/2,y:window.innerHeight/2,radius:s,stroke:"white",strokeWidth:1.5,opacity:0}),e=new Kinetic.Circle({x:window.innerWidth/2,y:window.innerHeight/2,radius:s,fill:n,opacity:i,strokeWidth:0}),i+=(.3-i)/C.concentricCircleNumber,d.add(e),d.add(t)}d.draw(),c.draw(),notify("User interface initialised.",1)},l.initNewNodeForm=function(){var e=$('<div class="new-node-form"></div>'),t=$('<div class="new-node-inner"></div>');e.append(t),t.append("<h1>Add a new contact</h1>"),t.append("<p>Some text accompanying the node creation box.</p>"),t.append('<input type="text" class="form-control name-box"></input>'),$(".content").after(e),$(document).on("keypress",P)},l.getKineticNodes=function(){return s.children},l.getKineticEdges=function(){return a.children},l.getSimpleNodes=function(){var e={},t=l.getKineticNodes();return $.each(t,function(t,n){e[n.attrs.id]={},e[n.attrs.id].x=n.attrs.x,e[n.attrs.id].y=n.attrs.y,e[n.attrs.id].name=n.attrs.name,e[n.attrs.id].type=n.attrs.type,e[n.attrs.id].size=n.attrs.size,e[n.attrs.id].color=n.attrs.color}),e},l.getSimpleEdges=function(){var e={},t=0;return $.each(a.children,function(n,o){e[t]={},e[t].from=o.attrs.from.attrs.id,e[t].to=o.attrs.to.attrs.id,t++}),e},l.getSimpleEdge=function(e){var t=l.getSimpleEdges();if(!e)return!1;var n=t[e];return n},l.getEdgeLayer=function(){return a},l.getNodeByID=function(e){var t={},n=l.getKineticNodes();return $.each(n,function(n,o){o.attrs.id===e&&(t=o)}),t},l.getNodeColorByType=function(e){var t=null;return $.each(C.nodeTypes,function(n,o){o.name===e&&(t=o.color)}),t?t:!1},l.init(),l};