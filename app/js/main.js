var DateInterface=function(){"use strict";var edges,dateInterface={};return dateInterface.options={targetEl:$(".container"),edgeType:"Dyad",heading:"Default Heading"},dateInterface.init=function(options){global.tools.extend(dateInterface.options,options),dateInterface.options.targetEl.append("<h1>"+dateInterface.options.heading+"</h1>"),dateInterface.options.targetEl.append('<p class="lead">'+dateInterface.options.subheading+"</p>"),dateInterface.options.targetEl.append('<div class="date-container"></div>'),edges=global.network.getEdges(dateInterface.options.criteria);var counter=0,row=0;$.each(edges,function(index,value){var dyadEdge=global.network.getEdges({type:"Dyad",from:global.network.getNodes({type_t0:"Ego"})[0].id,to:value.to})[0],markup='<div class="date-picker-item overlay"><div class="row"><div class="col-sm-12"><h2>Regarding <span>'+dyadEdge.nname_t0+'</span></h2></div></div><div class="row"><div class="col-sm-12 alert alert-danger logic-error" role="alert"><span class="glyphicon glyphicon-exclamation-sign" aria-hidden="true"></span><span class="sr-only">Error:</span> Your last sexual encounter cannot come before your first. Please correct the dates before continuing.</div><div class="col-sm-5"><div class="form-group"><p class="lead">When was the first time you had sex?</p><div class="input-group date first row'+row+'" id="datetimepicker'+counter+'"><input type="text" class="form-control" /><span class="input-group-addon"><span class="glyphicon glyphicon-calendar"></span></span></div><div class="checkbox"><label><input type="checkbox" name="checkbox-time" class="checkbox-time checkbox'+counter+'"> More than 6 months ago.</label></div></div></div><div class="col-sm-5 col-sm-offset-2"><div class="form-group"><p class="lead">When was the last time you had sex?</p><div class="input-group date second row'+row+'" id="datetimepicker'+(counter+1)+'"><input type="text" class="form-control" /><span class="input-group-addon"><span class="glyphicon glyphicon-calendar"></span></span></div></div></div></div></div>';$(markup).appendTo(".date-container");var dateoptions={format:"MM/DD/YYYY"};$("#datetimepicker"+counter).datetimepicker(dateoptions),$("#datetimepicker"+(counter+1)).datetimepicker(dateoptions),$("#datetimepicker"+counter+", #datetimepicker"+(counter+1)).on("dp.change",function(e){var target,first,second,incomingDate,properties={},$current=$(this);$(this).hasClass("first")?($(".checkbox"+$current.attr("id").slice(-1)).is(":checked")?(properties.sex_first_before_range=!0,incomingDate=null):(properties.sex_first_before_range=!1,incomingDate=$current.data("DateTimePicker").date().format("MM/DD/YYYY")),target=parseInt($current.attr("id").slice(-1))+1,first=parseInt($current.attr("id").slice(-1)),second=parseInt($current.attr("id").slice(-1))+1,null!==e.date,properties.sex_first_t0=incomingDate):($(".checkbox"+$current.attr("id").slice(-1)).is(":checked")?(properties.sex_last_before_range=!0,incomingDate=null):(properties.sex_last_before_range=!1,incomingDate=$current.data("DateTimePicker").date().format("MM/DD/YYYY")),target=parseInt($current.attr("id").slice(-1))-1,first=parseInt($current.attr("id").slice(-1))-1,second=parseInt($current.attr("id").slice(-1)),null!==e.date,properties.sex_last_t0=incomingDate),global.network.updateEdge(value.id,properties),global.moment($("#datetimepicker"+first).data("DateTimePicker").date()).isAfter($("#datetimepicker"+second).data("DateTimePicker").date())?($current.parent().parent().parent().children(".logic-error").fadeIn(),$(".arrow-next").attr("disabled","disabled")):($current.parent().parent().parent().children(".logic-error").fadeOut(),$(".arrow-next").removeAttr("disabled"))}),"undefined"!=typeof value.sex_first_t0&&(null===value.sex_first_t0?($(".checkbox"+counter).prop("checked",!0),$("#datetimepicker"+counter).data("DateTimePicker").date(global.moment().subtract(6,"months").format("MM/DD/YYYY")),$("#datetimepicker"+counter).children().css({opacity:.5}),$("#datetimepicker"+counter).data("DateTimePicker").disable()):$("#datetimepicker"+counter).data("DateTimePicker").date(value.sex_first_t0)),"undefined"!=typeof value.sex_last_t0&&(null===value.sex_last_t0?($(".checkbox"+(counter+1)).prop("checked",!0),$("#datetimepicker"+(counter+1)).data("DateTimePicker").date(global.moment().subtract(6,"months").format("MM/DD/YYYY")),$("#datetimepicker"+(counter+1)).children().css({opacity:.5}),$("#datetimepicker"+(counter+1)).data("DateTimePicker").disable()):$("#datetimepicker"+(counter+1)).data("DateTimePicker").date(value.sex_last_t0)),$(".checkbox"+counter+", .checkbox"+(counter+1)).change(function(e){var $target=$(e.target);this.checked?($target.parent().parent().parent().children(".date").data("DateTimePicker").date(global.moment().subtract(6,"months").format("MM/DD/YYYY")),$target.parent().parent().parent().children(".date").data("DateTimePicker").disable(),$target.parent().parent().parent().children(".date").children().css({opacity:.5})):($target.parent().parent().parent().children(".date").data("DateTimePicker").enable(),$target.parent().parent().parent().children(".date").children().css({opacity:1}),$target.parent().parent().parent().children(".date").data("DateTimePicker").date(global.moment().format("MM/DD/YYYY")))}),counter+=2,row++})},dateInterface.destroy=function(){},dateInterface};module.exports=new DateInterface;var Interview=function(){"use strict";var interview={},currentStage=0,$content=$("#content");return interview.id=0,interview.date=new Date,interview.stages=2,interview.init=function(){interview.goToStage(0),$(".arrow-next").click(function(){interview.nextStage()}),$(".arrow-prev").click(function(){interview.prevStage()})},interview.loadData=function(path){var data=JSON.parse(path);$.extend(interview,data)},interview.goToStage=function(stage){var newStage=stage;$content.transition({opacity:"0"},700,"easeInSine").promise().done(function(){$content.load("stages/"+stage+".html",function(){$content.transition({opacity:"1"},700,"easeInSine")})}),currentStage=newStage},interview.nextStage=function(){interview.goToStage(currentStage+1)},interview.prevStage=function(){interview.goToStage(currentStage-1)},interview},IOInterface=function(){"use strict";var db,id,Datastore=require("nedb"),path=require("path"),ioInterface={},initialised=!1;return ioInterface.init=function(callback){return callback?(global.tools.notify("ioInterface initialising.",1),global.tools.notify("Using "+global.session.name+" as database name.",1),db=new Datastore({filename:path.join(window.require("nw.gui").App.dataPath,global.session.name+".db"),autoload:!0}),void db.find({}).sort({"sessionParameters.date":1}).exec(function(err,docs){if(err)return!1;if(void 0!==docs.length&&docs.length>0)return global.tools.notify("ioInterface finished initialising.",1),initialised=!0,callback(docs[0]._id),!0;var sessionDate=new Date;db.insert([{sessionParameters:{date:sessionDate}}],function(err,newDoc){return err?!1:(id=newDoc[0]._id,initialised=!0,callback(newDoc[0]._id),global.tools.notify("ioInterface finished initialising.",1),!0)})})):!1},ioInterface.initialised=function(){return initialised?!0:!1},ioInterface.save=function(sessionData,id){delete global.session.sessionData._id,global.tools.notify("IOInterface being asked to save to data store.",1),global.tools.notify("Data to be saved: ",2),global.tools.notify(sessionData,2),db.update({_id:id},sessionData,{},function(err){return err?!1:void global.tools.notify("Saving complete.",1)})},ioInterface.update=function(key,sessionData,id){global.tools.notify("IOInterface being asked to update data store.",1),db.update({_id:id},sessionData,{},function(err){return err?!1:void global.tools.notify("Updating complete.",1)})},ioInterface.reset=function(callback){db.find({},function(err,docs){if(err)return!1;for(var resultLength=docs.length,i=0;resultLength>i;i++)ioInterface.deleteDocument(docs[i]._id);callback&&callback()})},ioInterface.deleteDocument=function(callback){global.tools.notify("ioInterface being asked to delete document.",2),db.remove({_id:global.session.id},{},function(err){return err?!1:(global.tools.notify("Deleting complete.",2),void(callback&&callback()))})},ioInterface.load=function(callback,id){global.tools.notify("ioInterface being asked to load data.",2),db.find({_id:id},function(err,docs){return err?!1:void callback(docs[0])})},ioInterface};module.exports=new IOInterface;var ListSelect=function(){"use strict";var listSelect={};listSelect.options={targetEl:$(".container"),variables:[],heading:"This is a default heading",subheading:"And this is a default subheading"};var itemClickHandler=function(){var properties={},nodeid=$(this).data("nodeid");$(this).data("selected")===!0?($(this).data("selected",!1),$(this).css({border:"2px solid #eee",background:"#eee"}),$.each(listSelect.options.variables,function(index,value){value.value===nodeid&&(properties[value.value]=void 0)}),global.network.updateNode(global.network.getNodes({type_t0:"Ego"})[0].id,properties)):($(this).data("selected",!0),$(this).css({border:"2px solid red",background:"#E8C0C0"}),$.each(listSelect.options.variables,function(index,value){value.value===nodeid&&(properties[value.value]=1)}),global.network.updateNode(global.network.getNodes({type_t0:"Ego"})[0].id,properties))},stageChangeHandler=function(){listSelect.destroy()},processSubmitHandler=function(){global.session.nextStage()};return listSelect.destroy=function(){global.tools.notify("Destroying listSelect.",0),$(window.document).off("click",".item",itemClickHandler),$(window.document).off("click",".continue",processSubmitHandler),window.removeEventListener("changeStageStart",stageChangeHandler,!1)},listSelect.init=function(options){global.tools.extend(listSelect.options,options),listSelect.options.targetEl.append('<h1 class="text-center">'+listSelect.options.heading+"</h1>"),listSelect.options.targetEl.append('<p class="lead text-center">'+listSelect.options.subheading+"</p>"),listSelect.options.targetEl.append('<div class="form-group list-container"></div>'),$.each(listSelect.options.variables,function(index,value){var el=$('<div class="item" data-nodeid="'+value.value+'"><h3>'+value.label+"</h3></div>"),properties={type_t0:"Ego"};properties[value.value]=1,global.network.getNodes(properties).length>0&&(el.data("selected",!0),el.css({border:"2px solid red",background:"#E8C0C0"})),$(".list-container").append(el)}),$(window.document).on("click",".item",itemClickHandler),$(window.document).on("click",".continue",processSubmitHandler),window.addEventListener("changeStageStart",stageChangeHandler,!1)},listSelect};module.exports=new ListSelect;var Logger=function(){"use strict";var logger={};return logger.init=function(){return global.tools.notify("Logger initialising.",1),global.log=global.session.registerData("log",!0),window.addEventListener("log",function(e){logger.addToLog(e.detail)},!1),!0},logger.addToLog=function(e){if(global.tools.notify("Event being added to log.",1),!e)return!1;var data={eventType:e.eventType,targetObject:e.eventObject,eventTime:new Date};global.session.addData("log",data,!0);var eventLogged=new window.CustomEvent("eventLogged",{detail:data});window.dispatchEvent(eventLogged);var unsavedChanges=new window.Event("unsavedChanges");return window.dispatchEvent(unsavedChanges),!0},logger.getLog=function(){return global.log},logger.getLastEvent=function(){},logger};module.exports=new Logger,global.$=$,global.L=L,global.Konva=Konva,global.gui=require("nw.gui");var moment=require("moment");global.moment=moment;var fs=require("fs"),path=require("path"),devMode=!1;global.debugLevel=10,global.studyProtocol="RADAR",$(".refresh-button").on("click",function(){console.log("yo");var _window=global.gui.Window.get();_window.reloadDev()}),console.log("netCanvas "+global.gui.App.manifest.version+" running on NWJS "+process.versions["node-webkit"]);var protocolExists=function(protocol,callback){var response=!1,availableProtocols=[];fs.readdir(path.join(path.resolve(),"protocols"),function(err,files){return err?(console.log(err),!1):(console.log("Available survey protocols:"),files.forEach(function(file){var stats=fs.statSync(path.join(path.resolve(),"protocols",file));stats.isDirectory()&&(console.log(file),availableProtocols.push(file))}),-1!==availableProtocols.indexOf(protocol)&&(response=!0),void(callback&&callback(response)))})},args=global.gui.App.argv;"undefined"!=typeof args&&-1!==args.indexOf("dev")&&(console.log("Development mode enabled."),devMode=!0),devMode?(global.gui.Window.get().showDevTools(),$(".refresh-button").show(),global.debugLevel=1):($(".refresh-button").hide(),global.gui.Window.get().enterFullscreen()),global.tools=require("./js/tools"),global.menu=require("./js/menu"),global.dataStore=require("./js/iointerface"),global.logger=require("./js/logger"),global.session=require("./js/session"),global.eventLog=require("./js/logger"),protocolExists(global.studyProtocol,function(exists){exists||(console.log("WARNING: Specified study protocol was not found. Using default."),global.studyProtocol="default"),global.session.init(function(){global.session.loadProtocol()}),global.logger.init()});var GeoInterface=function(){"use strict";function toggleFeature(e){if(taskComprehended===!1){var eventProperties={zoomLevel:leaflet.getZoom(),stage:global.session.currentStage(),timestamp:new Date};log=new window.CustomEvent("log",{detail:{eventType:"taskComprehended",eventObject:eventProperties}}),window.dispatchEvent(log),taskComprehended=!0}var mapEventProperties={zoomLevel:leaflet.getZoom(),timestamp:new Date};log=new window.CustomEvent("log",{detail:{eventType:"mapMarkerPlaced",eventObject:mapEventProperties}}),window.dispatchEvent(log);var properties,layer=e.target;mapNodeClicked===!1?(highlightFeature(e),properties={},properties[variable]=layer.feature.properties.name,global.network.updateEdge(edges[currentPersonIndex].id,properties),$(".map-node-location").html("<strong>Currently marked as:</strong> <br>"+layer.feature.properties.name)):layer.feature.properties.name===mapNodeClicked?(resetHighlight(e),mapNodeClicked=!1,properties={},properties[variable]=void 0,global.network.updateEdge(edges[currentPersonIndex].id,properties)):(resetAllHighlights(),highlightFeature(e),properties={},properties[variable]=layer.feature.properties.name,global.network.updateEdge(edges[currentPersonIndex].id,properties))}function highlightCurrent(){if(void 0!==edges[currentPersonIndex][variable])if(mapNodeClicked=edges[currentPersonIndex][variable],"Homeless"===edges[currentPersonIndex][variable]||"Jail"===edges[currentPersonIndex][variable]){resetPosition();var text="Homeless";"Jail"===edges[currentPersonIndex][variable]&&(text="in Jail"),$(".map-node-location").html("<strong>Currently marked as:</strong> <br>"+text)}else $.each(geojson._layers,function(index,value){value.feature.properties.name===edges[currentPersonIndex][variable]&&($(".map-node-location").html("<strong>Currently marked as:</strong> <br>"+edges[currentPersonIndex][variable]),selectFeature(value))});else resetPosition()}function highlightFeature(e){var layer=e.target;leaflet.fitBounds(e.target.getBounds(),{maxZoom:14}),layer.setStyle({fillOpacity:.8,fillColor:colors[1]}),global.L.Browser.ie||global.L.Browser.opera||layer.bringToFront(),mapNodeClicked=layer.feature.properties.name}function selectFeature(e){var layer=e;leaflet.fitBounds(e.getBounds(),{maxZoom:14}),layer.setStyle({fillOpacity:.8,fillColor:colors[1]}),global.L.Browser.ie||global.L.Browser.opera||layer.bringToFront()}function resetHighlight(e){$(".map-node-location").html(""),mapNodeClicked=!1,geojson.resetStyle(e.target)}function resetAllHighlights(){$(".map-node-location").html(""),mapNodeClicked=!1,$.each(geojson._layers,function(index,value){geojson.resetStyle(value)})}function onEachFeature(feature,layer){layer.on({click:toggleFeature})}function resetPosition(){leaflet.setView([41.798395426119534,-87.83967137233888],11)}function setHomeless(){resetAllHighlights();var properties={};properties[variable]="Homeless",global.network.updateEdge(edges[currentPersonIndex].id,properties),$(".map-node-location").html("<strong>Currently marked as:</strong> <br>Homeless")}function setJail(){resetAllHighlights();var properties={};properties[variable]="Jail",global.network.updateEdge(edges[currentPersonIndex].id,properties),$(".map-node-location").html("<strong>Currently marked as:</strong> <br>in Jail")}var log,leaflet,edges,geojson,taskComprehended=!1,geoInterface={},variable="res_chicago_location_p_t0",currentPersonIndex=0,mapNodeClicked=!1,colors=["#67c2d4","#1ECD97","#B16EFF","#FA920D","#e85657","#20B0CA","#FF2592","#153AFF","#8708FF"],stageChangeHandler=function(){geoInterface.destroy()};return geoInterface.nextPerson=function(){currentPersonIndex<edges.length-1&&(resetAllHighlights(),currentPersonIndex++,$(".current-id").html(currentPersonIndex+1),$(".map-node-status").html("Tap on the map to indicate the general area where <strong>"+edges[currentPersonIndex].nname_t0+"</strong> lives."),highlightCurrent(),currentPersonIndex===edges.length-1?$(".map-forwards").hide():$(".map-forwards").show(),0===currentPersonIndex?$(".map-back").hide():$(".map-back").show())},geoInterface.previousPerson=function(){currentPersonIndex>0&&(resetAllHighlights(),currentPersonIndex--,$(".current-id").html(currentPersonIndex+1),$(".map-node-status").html("Tap on the map to indicate the general area where <strong>"+edges[currentPersonIndex].nname_t0+"</strong> lives."),highlightCurrent(),currentPersonIndex===edges.length-1?$(".map-forwards").hide():$(".map-forwards").show(),0===currentPersonIndex?$(".map-back").hide():$(".map-back").show())},geoInterface.init=function(){leaflet=global.L.map("map",{maxBounds:[[41.4985986599114,-88.49824022406345],[42.1070175291862,-87.07098424716594]],zoomControl:!1}),global.L.tileLayer("http://{s}.{base}.maps.cit.api.here.com/maptile/2.1/maptile/{mapID}/normal.day.transit/{z}/{x}/{y}/256/png8?app_id={app_id}&app_code={app_code}",{subdomains:"1234",mapID:"newest",app_id:"FxdAZ7O0Wh568CHyJWKV",app_code:"FuQ7aPiHQcR8BSnXBCCmuQ",base:"base",minZoom:0,maxZoom:20}).addTo(leaflet),$.ajax({dataType:"json",url:"data/census2010.json",success:function(data){geojson=global.L.geoJson(data,{onEachFeature:onEachFeature,style:function(){return{weight:1,fillOpacity:0,strokeWidth:.2,color:colors[1]}}}).addTo(leaflet),edges=global.network.getEdges({from:global.network.getNodes({type_t0:"Ego"})[0].id,type:"Dyad",res_cat_p_t0:"Chicago"}),$(".map-counter").html('<span class="current-id">1</span>/'+edges.length),$(".map-node-status").html("Tap on the map to indicate the general area where <strong>"+edges[0].nname_t0+"</strong> lives."),highlightCurrent(),$(".map-back").hide(),currentPersonIndex===edges.length-1?$(".map-forwards").hide():$(".map-forwards").show()}}),window.addEventListener("changeStageStart",stageChangeHandler,!1),$(".map-back").on("click",geoInterface.previousPerson),$(".map-forwards").on("click",geoInterface.nextPerson),$(".homeless").on("click",setHomeless),$(".jail").on("click",setJail)},geoInterface.destroy=function(){leaflet.remove(),window.removeEventListener("changeStageStart",stageChangeHandler,!1),$(".map-back").off("click",geoInterface.previousPerson),$(".map-forwards").off("click",geoInterface.nextPerson),$(".homeless").on("click",setHomeless),$(".jail").on("click",setJail)},geoInterface};module.exports=new GeoInterface;var Menu=function(options){"use strict";var menu={},menus=[],isAnimating=!1,contentClickHandler=function(){menu.closeMenu()};return menu.options={onBeforeOpen:function(){$(".black").hide(),$(".arrow-next").transition({marginRight:-550},1e3),$(".arrow-prev").transition({marginLeft:-550},1e3),$(".content").addClass("pushed"),$(".pushed").on("click",contentClickHandler)},onAfterOpen:function(){return!1},onBeforeClose:function(){$(".content").removeClass("pushed"),$(".pushed").off("click",contentClickHandler)},onAfterClose:function(){$("body").css({"background-color":""}),$(".arrow-next").transition({marginRight:0},1e3),$(".arrow-prev").transition({marginLeft:0},1e3)}},menu.getMenus=function(){return menus},menu.closeMenu=function(targetMenu){targetMenu?targetMenu.closeBtn.trigger("click"):$.each(menus,function(index){menus[index].open===!0&&menus[index].closeBtn.trigger("click")})},menu.toggle=function(targetMenu){var targetMenuObj=$("."+targetMenu.name+"-menu");if(isAnimating===!0)return!1;if(isAnimating=!0,targetMenu.open===!0)menu.options.onBeforeClose(),targetMenuObj.removeClass("open"),targetMenu.open=!1,setTimeout(menu.options.onAfterClose,1e3),isAnimating=!1;else{menu.options.onBeforeOpen();var col=global.tools.modifyColor($("."+targetMenu.name+"-menu").css("background-color"),-.2);$("body").css({"background-color":col}),targetMenuObj.addClass("open"),targetMenu.open=!0,setTimeout(menu.options.onAfterOpen,500),isAnimating=!1}},menu.addMenu=function(name,icon){var newMenu={};newMenu.name=name,newMenu.open=!1,newMenu.button=$('<span class="hi-icon menu-btn '+name+' shown"></span>'),newMenu.button.addClass(icon).html(name),$(".menu-container").append(newMenu.button);var menuClass=name+"-menu";return newMenu.menu=$('<div class="menu '+menuClass+'"><div class="menu-content"><h2>'+name+"</h2><ul></ul></div></div>"),newMenu.closeBtn=$('<span class="icon icon-close"><i class="fa fa-times fa-2x"></i></span>'),$(newMenu.menu).append(newMenu.closeBtn),$(".menu-container").append(newMenu.menu),newMenu.button.on("click",function(){$(".menu-btn").removeClass("shown"),menu.toggle(newMenu)}),newMenu.closeBtn.on("click",function(){$(".menu-btn").addClass("shown"),menu.toggle(newMenu)}),menus.push(newMenu),newMenu},menu.removeMenu=function(targetMenu){$(targetMenu.button).remove(),$(targetMenu.items).remove()},menu.addItem=function(targetMenu,item,icon,callback){var listIcon="fa-file-text";icon&&(listIcon=icon);var menuItem=$('<li><span class="fa '+listIcon+' fa-2x menu-icon"></span> '+item+"</li>");targetMenu.menu.find("ul").append(menuItem),menuItem.on("click",function(){$(".paginate").removeAttr("disabled"),menu.closeMenu(targetMenu),setTimeout(function(){callback()},500)})},menu.init=function(){global.tools.notify("Menu initialising.",1),global.tools.extend(menu.options,options)},menu.init(),menu};module.exports=new Menu;var MultiBin=function(){"use strict";var log,followup,taskComprehended=!1,multiBin={};multiBin.options={targetEl:$(".container"),edgeType:"Dyad",variable:{label:"multibin_variable",values:["Variable 1"]},filter:void 0,heading:"Default Heading",subheading:"Default Subheading."};var open=!1,stageChangeHandler=function(){multiBin.destroy()},followupHandler=function(e){e.preventDefault();var nodeid=followup,criteria={to:nodeid};global.tools.extend(criteria,multiBin.options.criteria);var edge=global.network.getEdges(criteria)[0],followupProperties={};$.each(multiBin.options.followup.questions,function(index){var followupVal=$("#"+multiBin.options.followup.questions[index].variable).val();followupProperties[multiBin.options.followup.questions[index].variable]=followupVal}),global.tools.extend(edge,followupProperties),global.network.updateEdge(edge.id,edge),$.each(multiBin.options.followup.questions,function(index){$("#"+multiBin.options.followup.questions[index].variable).val("")}),$(".followup").hide(),$(".black-overlay").hide()},followupCancelHandler=function(){$("#"+multiBin.options.followup.variable).val(""),$(".followup").hide(),$(".black-overlay").hide()},backgroundClickHandler=function(e){e.stopPropagation(),e.target!==e.currentTarget&&open===!0&&($(".node-bin-container").children().show(),$(".node-question-container").show(),$(".copy").removeClass("node-bin-active"),$(".copy").addClass("node-bin-static"),$(".copy").children("h1, p").show(),$(".copy").removeClass("copy"),$(".draggable").draggable({cursor:"pointer",revert:"invalid",disabled:!1,start:function(){if(taskComprehended===!1){var eventProperties={stage:global.session.currentStage(),timestamp:new Date};log=new window.CustomEvent("log",{detail:{eventType:"taskComprehended",eventObject:eventProperties}}),window.dispatchEvent(log),taskComprehended=!0}}}),open=!1)},nodeBinClickHandler=function(e){if(e.stopPropagation(),open===!1){if($(".draggable").draggable({cursor:"pointer",revert:"invalid",disabled:!0,start:function(){if(taskComprehended===!1){var eventProperties={stage:global.session.currentStage(),timestamp:new Date};log=new window.CustomEvent("log",{detail:{eventType:"taskComprehended",eventObject:eventProperties}}),window.dispatchEvent(log),taskComprehended=!0}}}),!$(this).hasClass(".node-bin-active")){$(".node-bin-container").children().not(this).hide(),$(".node-question-container").hide();var position=$(this).offset(),nodeBinDetails=$(this);nodeBinDetails.offset(position),nodeBinDetails.addClass("node-bin-active copy"),nodeBinDetails.removeClass("node-bin-static"),nodeBinDetails.children("h1, p").hide(),nodeBinDetails.children(".active-node-list").children(".node-bucket-item").css({top:0,left:20,opacity:0}),setTimeout(function(){nodeBinDetails.addClass("node-bin-active"),$.each($(".active-node-list").children(),function(index,value){setTimeout(function(){$(value).transition({left:0,opacity:1})},20*index)})},100)}open=!0}},nodeClickHandler=function(e){e.stopPropagation();var el=$(this),id=$(this).parent().parent().data("index");if($(this).parent().hasClass("active-node-list")){var edgeID=global.network.getEdges({from:global.network.getNodes({type_t0:"Ego"})[0].id,to:el.data("node-id"),type:multiBin.options.edgeType})[0].id,properties={};properties[multiBin.options.variable.label]="","undefined"!=typeof multiBin.options.followup&&$.each(multiBin.options.followup.questions,function(index,value){properties[value.variable]=void 0}),global.network.updateEdge(edgeID,properties),$(this).fadeOut(400,function(){$(this).appendTo(".node-bucket"),$(this).css("display","");var noun="people";1===$(".c"+id).children(".active-node-list").children().length&&(noun="person"),0===$(".c"+id).children(".active-node-list").children().length?$(".c"+id).children("p").html("(Empty)"):$(".c"+id).children("p").html($(".c"+id).children(".active-node-list").children().length+" "+noun+".")})}};return multiBin.destroy=function(){global.tools.notify("Destroying multiBin.",0),window.removeEventListener("changeStageStart",stageChangeHandler,!1),$(".node-bin-static").off("click",nodeBinClickHandler),$(".node-bucket-item").off("click",nodeClickHandler),$(".content").off("click",backgroundClickHandler),$(".followup-submit").off("click",followupHandler),$(".followup-cancel").off("click",followupCancelHandler),$(".followup").remove()},multiBin.init=function(options){if(global.tools.extend(multiBin.options,options),multiBin.options.targetEl.append('<div class="node-question-container"></div>'),$(".node-question-container").append("<h1>"+multiBin.options.heading+"</h1>"),$(".node-question-container").append('<div class="node-bucket"></div>'),"undefined"!=typeof multiBin.options.followup){if($("body").append('<div class="followup overlay"><form class="followup-form"></form></div>'),"undefined"!=typeof multiBin.options.followup.linked&&multiBin.options.followup.linked===!0){var first=!0;$.each(multiBin.options.followup.questions,function(index,value){$(".followup").children("form").append("<h2>"+value.prompt+'</h2><div class="row form-group"><input type="number" class="form-control '+value.variable+'" id="'+value.variable+'" required></div>'),first&&$("#"+value.variable).change(function(){$("#"+multiBin.options.followup.questions[index+1].variable).val()>$("#"+value.variable).val()&&$("#"+multiBin.options.followup.questions[index+1].variable).val($("#"+value.variable).val()),$("#"+multiBin.options.followup.questions[index+1].variable).attr("max",$("#"+value.variable).val())}),first=!first})}else $.each(multiBin.options.followup.questions,function(index,value){$(".followup").children("form").append("<h2>"+value.prompt+'</h2><div class="row form-group"><input type="text" class="form-control '+value.variable+'" id="'+value.variable+'" required></div>')});$(".followup").children("form").append('<div class="row form-group"><button type="submit" class="btn btn-primary btn-block followup-submit">Continue</button></div>'),"undefined"!=typeof multiBin.options.followup.cancel&&$(".overlay").children().last(".form-group").append('<div class="row form-group"><button type="submit" class="btn btn-warning btn-block followup-cancel">'+multiBin.options.followup.cancel+"</button></div>")}multiBin.options.targetEl.append('<div class="node-bin-container"></div>');for(var number=Math.floor(.66*multiBin.options.variable.values.length),itemSizeW=$(".container").outerWidth()/number,itemSize=itemSizeW;2*itemSize>$(".container").height()-200;)itemSize=.98*itemSize;var edges=global.network.getEdges(multiBin.options.criteria,multiBin.options.filter);$.each(multiBin.options.variable.values,function(index,value){var newBin=$('<div class="node-bin node-bin-static c'+index+'" data-index="'+index+'"><h1>'+value+'</h1><p class="lead">(Empty)</p><div class="active-node-list"></div></div>');newBin.data("index",index),$(".node-bin-container").append(newBin),$(".c"+index).droppable({accept:".draggable",drop:function(event,ui){var dropped=ui.draggable,droppedOn=$(this);if("undefined"!=typeof multiBin.options.followup&&multiBin.options.followup.trigger.indexOf(multiBin.options.variable.values[index])>=0)$(".followup").show(),$(".black-overlay").show(),$("#"+multiBin.options.followup.questions[0].variable).focus(),followup=$(dropped).data("node-id");else if("undefined"!=typeof multiBin.options.followup){var nodeid=$(dropped).data("node-id"),criteria={to:nodeid};global.tools.extend(criteria,multiBin.options.criteria);var edge=global.network.getEdges(criteria)[0],followupProperties={};$.each(multiBin.options.followup.questions,function(index){followupProperties[multiBin.options.followup.questions[index].variable]=void 0}),global.tools.extend(edge,followupProperties),global.network.updateEdge(edge.id,edge),$.each(multiBin.options.followup.questions,function(index){$("#"+multiBin.options.followup.questions[index].variable).val("")})}$(dropped).appendTo(droppedOn.children(".active-node-list"));var properties={};properties[multiBin.options.variable.label]=multiBin.options.variable.values[index];var edgeID=global.network.getEdges({from:global.network.getNodes({type_t0:"Ego"})[0].id,to:$(dropped).data("node-id"),type:multiBin.options.edgeType})[0].id;global.network.updateEdge(edgeID,properties);var noun="people";1===$(".c"+index+" .active-node-list").children().length&&(noun="person"),$(".c"+index+" p").html($(".c"+index+" .active-node-list").children().length+" "+noun+".");var el=$(".c"+index);el.transition({scale:1.2},200,"ease"),setTimeout(function(){el.transition({background:el.data("oldBg")},200,"ease"),el.transition({scale:1},200,"ease")},0)},over:function(){$(this).data("oldBg",$(this).css("background-color")),$(this).stop().transition({background:"rgba(255, 193, 0, 1.0)"},400,"ease")},out:function(){$(this).stop().transition({background:$(this).data("oldBg")},500,"ease")}})}),$(".node-bin").css({width:itemSize-20,height:itemSize-20}),$.each($(".node-bin"),function(index,value){var oldPos=$(value).offset();$(value).data("oldPos",oldPos),$(value).css(oldPos)}),$(".node-bin").css({position:"absolute"}),$.each(edges,function(index,value){var dyadEdge=global.network.getEdges({from:global.network.getNodes({type_t0:"Ego"})[0].id,type:"Dyad",to:value.to})[0];if(void 0!==value[multiBin.options.variable.label]&&""!==value[multiBin.options.variable.label]){index=multiBin.options.variable.values.indexOf(value[multiBin.options.variable.label]),$(".c"+index).children(".active-node-list").append('<div class="node-bucket-item draggable" data-node-id="'+value.to+'">'+dyadEdge.nname_t0+"</div>");var noun="people";1===$(".c"+index).children(".active-node-list").children().length&&(noun="person"),0===$(".c"+index).children(".active-node-list").children().length?$(".c"+index).children("p").html("(Empty)"):$(".c"+index).children("p").html($(".c"+index).children(".active-node-list").children().length+" "+noun+".");
}else $(".node-bucket").append('<div class="node-bucket-item draggable" data-node-id="'+value.to+'">'+dyadEdge.nname_t0+"</div>")}),$(".draggable").draggable({cursor:"pointer",revert:"invalid",disabled:!1,start:function(){if(taskComprehended===!1){var eventProperties={stage:global.session.currentStage(),timestamp:new Date};log=new window.CustomEvent("log",{detail:{eventType:"taskComprehended",eventObject:eventProperties}}),window.dispatchEvent(log),taskComprehended=!0}}}),window.addEventListener("changeStageStart",stageChangeHandler,!1),$(".node-bin-static").on("click",nodeBinClickHandler),$(".node-bucket-item").on("click",nodeClickHandler),$(".content").on("click",backgroundClickHandler),$(".followup-form").on("submit",followupHandler),$(".followup-cancel").on("click",followupCancelHandler)},multiBin};module.exports=new MultiBin;var Namegenerator=function(){"use strict";var namegenerator={};namegenerator.options={nodeType:"Alter",edgeType:"Dyad",targetEl:$(".container"),variables:[],heading:"This is a default heading",subheading:"And this is a default subheading",panels:[]};var nodeBoxOpen=!1,editing=!1,alterCount=global.network.getNodes({type_t0:"Alter"}).length,roles={Friend:["Best Friend","Friend","Ex-friend","Other type"],"Family / Relative":["Parent / Guardian","Brother / Sister","Grandparent","Other Family","Chosen Family"],"Romantic / Sexual Partner":["Boyfriend / Girlfriend","Ex-Boyfriend / Ex-Girlfriend","Booty Call / Fuck Buddy / Hook Up","One Night Stand","Other type of Partner"],"Acquaintance / Associate":["Coworker / Colleague","Classmate","Roommate","Friend of a Friend","Neighbor","Other"],"Other Support / Source of Advice":["Teacher / Professor","Counselor / Therapist","Community Agency Staff","Religious Leader","Mentor","Coach","Other"],"Drug Use":["Someone you use drugs with","Someone you buy drugs from"],Other:["Other relationship"]},namesList=["Barney","Joshua","Jonathon","Myles","Alethia","Tammera","Veola","Meredith","Renee","Grisel","Celestina","Fausto","Eliana","Raymundo","Lyle","Carry","Kittie","Melonie","Elke","Mattie","Kieth","Lourie","Marcie","Trinity","Librada","Lloyd","Pearlie","Velvet","Stephan","Hildegard","Winfred","Tempie","Maybelle","Melynda","Tiera","Lisbeth","Kiera","Gaye","Edra","Karissa","Manda","Ethelene","Michelle","Pamella","Jospeh","Tonette","Maren","Aundrea","Madelene","Epifania","Olive"],keyPressHandler=function(e){13===e.keyCode&&(e.preventDefault(),nodeBoxOpen===!1?namegenerator.openNodeBox():nodeBoxOpen===!0&&$(".submit-1").click()),27===e.keyCode&&namegenerator.closeNodeBox(),8!==e.keyCode||$(e.target).is("input, textarea")||e.preventDefault()},roleClickHandler=function(){$(this).data("selected")===!0?($(this).data("selected",!1),$(this).removeClass("selected")):($(this).data("selected",!0),$(this).addClass("selected"))},inputKeypressHandler=function(e){if(nodeBoxOpen===!0&&13!==e.keyCode&&$("#fname_t0").val().length>0&&$("#fname_t0").val().length>0){var lname=$("#fname_t0").val()+" "+$("#lname_t0").val().charAt(0);$("#lname_t0").val().length>0&&(lname+=".");var updateName=function(){$("#nname_t0").val(lname)};setTimeout(updateName,0)}},stageChangeHandler=function(){namegenerator.destroy()},cardClickHandler=function(){if($(this).hasClass("ghost"))return!1;var index=$(this).data("index"),edge=global.network.getEdges({from:global.network.getNodes({type_t0:"Ego"})[0].id,to:index,type:"Dyad"})[0];editing=index;var roleCount=global.network.getEdges({from:global.network.getNodes({type_t0:"Ego"})[0].id,to:editing,type:"Role"}).length;$(".relationship-button").html(roleCount+" roles selected."),$.each(namegenerator.options.variables,function(index,value){value["private"]===!1&&("relationship"===value.type?$('select[name="'+value.variable+'"]').val(edge[value.variable]):$("#"+value.variable).val(edge[value.variable]),$(".delete-button").show(),edge.elicited_previously===!0?$("input#age_p_t0").prop("disabled",!0):$("input#age_p_t0").prop("disabled",!1),namegenerator.openNodeBox())})},cancelBtnHandler=function(){$(".delete-button").hide(),namegenerator.closeNodeBox()},selectChangeHandler=function(){return""===$('select[name="reltype_main_t0"]').val()?($('select[name="reltype_sub_t0"]').prop("disabled",!0),!1):($('select[name="reltype_sub_t0"]').prop("disabled",!1),$('select[name="reltype_sub_t0"]').children().remove(),$('select[name="reltype_sub_t0"]').append('<option value="">Choose a specific relationship</option>'),void $.each(roles[$('select[name="reltype_main_t0"]').val()],function(index,value){$('select[name="reltype_sub_t0"]').append('<option value="'+value+'">'+value+"</option>")}))},selectSubChangeHandler=function(){"Other"===$('select[name="reltype_sub_t0"]').val()?$(".reltype_oth_t0").show():($(".reltype_oth_t0").val(""),$(".reltype_oth_t0").hide())},submitFormHandler=function(e){e.preventDefault();var newEdgeProperties={},newNodeProperties={};$(".delete-button").hide(),$.each(namegenerator.options.variables,function(index,value){"edge"===value.target?value["private"]===!0?newEdgeProperties[value.variable]=value.value:"relationship"===value.type||"subrelationship"===value.type?newEdgeProperties[value.variable]=$('select[name="'+value.variable+'"]').val():newEdgeProperties[value.variable]=$("#"+value.variable).val():"node"===value.target&&(value["private"]===!0?newNodeProperties[value.variable]=value.value:"relationship"===value.type||"subrelationship"===value.type?newNodeProperties[value.variable]=$('select[name="'+value.variable+'"]').val():newNodeProperties[value.variable]=$("#"+value.variable).val())});var nodeProperties={},edgeProperties={};if(editing===!1){global.tools.extend(nodeProperties,newNodeProperties);var id,newNode=global.network.addNode(nodeProperties);$.each(namegenerator.options.edgeTypes,function(index,value){var currentEdgeProperties={},currentEdge=value;$.each(namegenerator.options.variables,function(index,value){"edge"===value.target&&value.edge===currentEdge&&(value["private"]===!0?currentEdgeProperties[value.variable]=value.value:"relationship"===value.type||"subrelationship"===value.type?currentEdgeProperties[value.variable]=$('select[name="'+value.variable+'"]').val():currentEdgeProperties[value.variable]=$("#"+value.variable).val())}),edgeProperties={from:global.network.getNodes({type_t0:"Ego"})[0].id,to:newNode,type:currentEdge},global.tools.extend(edgeProperties,currentEdgeProperties),id=global.network.addEdge(edgeProperties)}),$.each($(".relationship.selected"),function(){edgeProperties={type:"Role",from:global.network.getNodes({type_t0:"Ego"})[0].id,to:newNode,reltype_main_t0:$(this).parent(".relationship-type").data("main-relationship"),reltype_sub_t0:$(this).data("sub-relationship")},global.network.addEdge(edgeProperties)});var edge=global.network.getEdges({to:newNode,type:"Dyad"})[0];namegenerator.addToList(edge),alterCount++,$(".alter-count-box").html(alterCount)}else{var color=function(){var el=$("div[data-index="+editing+"]"),current=el.css("background-color");el.stop().transition({background:"#1ECD97"},400,"ease"),setTimeout(function(){el.stop().transition({background:current},800,"ease")},700)},nodeID=editing;$.each(namegenerator.options.edgeTypes,function(index,value){var currentEdge=value,currentEdgeProperties={};$.each(namegenerator.options.variables,function(index,value){"edge"===value.target&&value.edge===currentEdge&&(value["private"]===!0?currentEdgeProperties[value.variable]=value.value:"relationship"===value.type||"subrelationship"===value.type?currentEdgeProperties[value.variable]=$('select[name="'+value.variable+'"]').val():currentEdgeProperties[value.variable]=$("#"+value.variable).val())});var edges=global.network.getEdges({from:global.network.getNodes({type_t0:"Ego"})[0].id,to:editing,type:value});$.each(edges,function(index,value){global.network.updateEdge(value.id,currentEdgeProperties,color)})}),global.network.updateNode(nodeID,newNodeProperties);var properties=global.tools.extend(newEdgeProperties,newNodeProperties);global.network.removeEdges(global.network.getEdges({type:"Role",from:global.network.getNodes({type_t0:"Ego"})[0].id,to:editing})),$.each($(".relationship.selected"),function(){edgeProperties={type:"Role",from:global.network.getNodes({type_t0:"Ego"})[0].id,to:editing,reltype_main_t0:$(this).parent(".relationship-type").data("main-relationship"),reltype_sub_t0:$(this).data("sub-relationship")},global.network.addEdge(edgeProperties)}),$("div[data-index="+editing+"]").html(""),$("div[data-index="+editing+"]").append("<h4>"+properties.nname_t0+"</h4>");var list=$("<ul></ul>");$.each(namegenerator.options.variables,function(index,value){value["private"]===!1&&void 0!==properties[value.variable]&&""!==properties[value.variable]&&list.append('<li class="'+properties[value.variable]+'"><strong>'+value.label+"</strong>: "+properties[value.variable]+"</li>")}),$("div[data-index="+editing+"]").append(list),editing=!1}namegenerator.closeNodeBox()};return namegenerator.generateTestAlters=function(number){if(!number)return global.tools.notify("You must specify the number of test alters you want to create. Cancelling!",2),!1;for(var eachTime=4e3,i=0;number>i;i++)setTimeout(function(){$(".add-button").click(),setTimeout(function(){$("#ngForm").submit()},3e3),$("#fname_t0").val(namesList[Math.floor(global.tools.randomBetween(0,namesList.length))]),$("#lname_t0").val(namesList[Math.floor(global.tools.randomBetween(0,namesList.length))]);var lname=$("#fname_t0").val()+" "+$("#lname_t0").val().charAt(0);$("#lname_t0").val().length>0&&(lname+="."),$("#nname_t0").val(lname),$("#age_p_t0").val(Math.floor(global.tools.randomBetween(18,90))),setTimeout(function(){$(".relationship-button").click()},500),setTimeout(function(){for(var roleNumber=Math.floor(global.tools.randomBetween(1,3)),j=0;roleNumber>j;j++)$($(".relationship")[Math.floor(global.tools.randomBetween(0,$(".relationship").length))]).addClass("selected");$(".relationship-close-button").click()},2e3)},eachTime*i)},namegenerator.openNodeBox=function(){$(".content").addClass("blurry"),$(".newNodeBox").addClass("open"),$("#ngForm input:text").first().focus(),nodeBoxOpen=!0},namegenerator.closeNodeBox=function(){$(".content").removeClass("blurry"),$(".newNodeBox").removeClass("open"),setTimeout(function(){}),nodeBoxOpen=!1,$("#ngForm").trigger("reset"),$(".reltype_oth_t0").hide(),editing=!1,$(".relationship-button").html("Set Relationship Roles"),$(".relationship").removeClass("selected")},namegenerator.destroy=function(){global.tools.notify("Destroying namegenerator.",0),$(window.document).off("keydown",keyPressHandler),$(".cancel").off("click",cancelBtnHandler),$("#fname_t0, #lname_t0").off("keyup",inputKeypressHandler),$(window.document).off("click",".inner-card",cardClickHandler),$(".add-button").off("click",namegenerator.openNodeBox),$(".delete-button").off("click",namegenerator.removeFromList),$('select[name="reltype_main_t0"]').off("change",selectChangeHandler),$('select[name="reltype_sub_t0"]').off("change",selectSubChangeHandler),$("#ngForm").off("submit",submitFormHandler),window.removeEventListener("changeStageStart",stageChangeHandler,!1),$(".newNodeBox").remove(),$(".relationship-types-container").remove(),$(window.document).off("click",".relationship",roleClickHandler),$(window.document).off("click",".relationship-button",namegenerator.toggleRelationshipBox),$(window.document).off("click",".relationship-close-button",namegenerator.toggleRelationshipBox)},namegenerator.init=function(options){global.tools.extend(namegenerator.options,options);var button=$('<span class="hi-icon hi-icon-user add-button">Add</span>');namegenerator.options.targetEl.append(button);var alterCountBox=$('<div class="alter-count-box"></div>');namegenerator.options.targetEl.append(alterCountBox);var newNodeBox=$('<div class="newNodeBox overlay"><form role="form" id="ngForm" class="form"><div class="col-sm-6 left"><h2 style="margin-top:0">Adding a Person</h2><ul><li>Try to be as accurate as you can, but don\'t worry if you aren\'t sure.</li><li>We are interested in your perceptions, so there are no right or wrong answers!</li><li>You can use the tab key to quickly move between the fields.</li><li>You can use the enter key to submit the form.</li></ul></div><div class="col-sm-6 right"></div></form></div>');$("body").append(newNodeBox),$.each(namegenerator.options.variables,function(index,value){if(value["private"]!==!0){var formItem;switch(value.type){case"text":formItem=$('<div class="form-group '+value.variable+'"><label class="sr-only" for="'+value.variable+'">'+value.label+'</label><input type="text" class="form-control '+value.variable+'" id="'+value.variable+'" placeholder="'+value.label+'"></div></div>');break;case"number":formItem=$('<div class="form-group '+value.variable+'"><label class="sr-only" for="'+value.variable+'">'+value.label+'</label><input type="number" class="form-control '+value.variable+'" id="'+value.variable+'" placeholder="'+value.label+'"></div></div>');break;case"relationship":formItem=$('<input type="hidden" class="form-control '+value.variable+'" id="'+value.variable+'" placeholder="'+value.label+'">');break;case"subrelationship":formItem=$('<input type="hidden" class="form-control '+value.variable+'" id="'+value.variable+'" placeholder="'+value.label+'">')}$(".newNodeBox .form .right").append(formItem),value.required===!0&&("relationship"===value.type?$('select[name="'+value.variable+'"]').prop("required",!0):$("#"+value.variable).prop("required",!0))}}),$(".newNodeBox .form .right").append('<div class="form-group"><button type="button" class="btn btn-primary btn-block relationship-button">Set Relationship Roles</div></div>'),$('select[name="reltype_sub_t0"]').prop("disabled",!0);var buttons=$('<div class="row form-group"><br/></div><div class="row form-group"><div class="col-sm-4"><button type="submit" class="btn btn-success btn-block submit-1"><span class="glyphicon glyphicon-plus-sign"></span> Add</button></div><div class="col-sm-4"><button type="button" class="btn btn-danger btn-block delete-button"><span class="glyphicon glyphicon-trash"></span> Delete</button></div><div class="col-sm-4"><span class="btn btn-warning btn-block cancel">Cancel</span></div></div>');$(".newNodeBox .form .right").append(buttons),$(".reltype_oth_t0").hide(),alterCountBox=$('<div class="relationship-types-container"><span class="relationship-close-button">X</span>'),$(".newNodeBox").after(alterCountBox);var counter=0;$.each(roles,function(index){$(".relationship-types-container").append('<div class="relationship-type rel-'+counter+" c"+counter+'" data-main-relationship="'+counter+'"><h1>'+index+"</h1></div>"),$.each(roles[index],function(relIndex,relValue){$(".rel-"+counter).append('<div class="relationship" data-sub-relationship="'+relValue+'">'+relValue+"</div>")}),counter++});var nodeContainer=$('<div class="question-container"></div><div class="node-container-bottom-bg"></div>');namegenerator.options.targetEl.append(nodeContainer);var title=$('<h1 class="text-center"></h1>').html(namegenerator.options.heading);$(".question-container").append(title);var subtitle=$('<p class="lead text-center"></p>').html(namegenerator.options.subheading);$(".question-container").append(subtitle);var nameList=$('<div class="node-container nameList"></div>');if(namegenerator.options.targetEl.append(nameList),window.addEventListener("changeStageStart",stageChangeHandler,!1),$(window.document).on("keydown",keyPressHandler),$(".cancel").on("click",cancelBtnHandler),$(".add-button").on("click",namegenerator.openNodeBox),$(".delete-button").on("click",namegenerator.removeFromList),$("#fname_t0, #lname_t0").on("keyup",inputKeypressHandler),$(window.document).on("click",".inner-card",cardClickHandler),$('select[name="reltype_main_t0"]').on("change",selectChangeHandler),$('select[name="reltype_sub_t0"]').on("change",selectSubChangeHandler),$("#ngForm").on("submit",submitFormHandler),$(window.document).on("click",".relationship",roleClickHandler),$(window.document).on("click",".relationship-button",namegenerator.toggleRelationshipBox),$(window.document).on("click",".relationship-close-button",namegenerator.toggleRelationshipBox),$(".alter-count-box").html(alterCount),$.each(global.network.getEdges({type:"Dyad",from:global.network.getNodes({type_t0:"Ego"})[0].id,ng_t0:namegenerator.options.variables[5].value}),function(index,value){namegenerator.addToList(value)}),namegenerator.options.panels.length>0){var sideContainer=$('<div class="side-container"></div>');if(-1!==namegenerator.options.panels.indexOf("current")&&(sideContainer.append($('<div class="current-node-list node-lists"><h4>People you already listed:</h4></div>')),$.each(global.network.getEdges({type:"Dyad",from:global.network.getNodes({type_t0:"Ego"})[0].id}),function(index,value){var el=$('<div class="node-list-item">'+value.nname_t0+"</div>");sideContainer.children(".current-node-list").append(el)})),-1!==namegenerator.options.panels.indexOf("previous")&&"undefined"!=typeof global.session.sessionData.previousNetwork){if("undefined"==typeof global.previousNetwork){var Network=require("./network");global.previousNetwork=new Network,global.previousNetwork.loadNetwork(global.session.sessionData.previousNetwork)}global.previousNetwork.getNodes().length>1&&(sideContainer.append($('<div class="previous-node-list node-lists"><h4>People you listed in other visits:</h4></div>')),$.each(global.previousNetwork.getEdges({type:"Dyad",from:global.previousNetwork.getEgo().id}),function(index,value){var el=$('<div class="node-bucket-item draggable" data-id="'+value.to+'">'+value.nname_t0+"</div>");sideContainer.children(".previous-node-list").append(el)}))}sideContainer.children().length>0&&(sideContainer.insertBefore(".nameList"),$(".nameList").addClass("alt"),$(".draggable").draggable({cursor:"pointer",revert:"invalid",disabled:!1,start:function(){console.log($(this).parent().css("overflow")),$(this).parent().css("overflow","visible"),console.log($(this).parent().css("overflow"))},stop:function(){$("previous-node-list").css("overflow","scroll"),$("current-node-list").css("overflow","scroll")}}),$(".node-container").droppable({accept:".draggable",drop:function(event,ui){$("previous-node-list").css("overflow","scroll"),$("current-node-list").css("overflow","scroll"),$(".card.ghost").remove();var ngStep,dropped=ui.draggable,droppedNode=dropped.data("id"),droppedNodeEdge=global.previousNetwork.getEdges({type:"Dyad",from:global.previousNetwork.getEgo().id,to:droppedNode})[0];$.each(namegenerator.options.variables,function(index,value){"ng_t0"===value.label&&(ngStep=value.value)}),droppedNodeEdge.ng_t0=ngStep,namegenerator.addToList(droppedNodeEdge);var oldNode=global.previousNetwork.getNode(droppedNode);droppedNodeEdge.elicited_previously=!0,global.network.addNode(oldNode,!1,!0),global.network.addEdge(droppedNodeEdge),$(".inner-card").last().click(),setTimeout(function(){$(".relationship-button").click()},300),global.previousNetwork.removeNode(oldNode.id),global.session.addData("previousNetwork",{nodes:global.previousNetwork.getNodes(),edges:global.previousNetwork.getEdges()}),$(dropped).remove(),$(".card.ghost").removeClass("show")},over:function(){$(".node-container").scrollTop($(".node-container")[0].scrollHeight),$(".node-container").append('<div class="card ghost"><div class="inner-card ghost"><i class="fa fa-5x fa-plus-circle"></i>Add</div></div>'),setTimeout(function(){$(".card.ghost").addClass("show")},100)},out:function(){$(".card.ghost").removeClass("show"),setTimeout(function(){$(".card.ghost").remove()},300)}})),$(".side-container").children().length>1&&$(".node-lists").addClass("double")}},namegenerator.toggleRelationshipBox=function(){if($(".relationship-types-container").hasClass("open")){var roleCount=$(".relationship.selected").length,plural="roles";1===roleCount&&(plural="role"),editing?$(".relationship-button").html(roleCount+" "+plural+" selected."):roleCount>0?$(".relationship-button").html(roleCount+" "+plural+" selected."):$(".relationship-button").html("Set Relationship Roles"),$.each($(".relationship-type"),function(index,value){setTimeout(function(){$(value).transition({opacity:0,top:"-100px"},150),$.each($(value).children(".relationship"),function(index,childvalue){setTimeout(function(){$(childvalue).transition({opacity:0,top:"-200px"},150)},50+20*index)})},50*index)}),setTimeout(function(){$(".relationship-types-container").removeClass("open"),$(".relationship-types-container").removeClass("front"),$(".newNodeBox").removeClass("back"),setTimeout(function(){},1e3)},400)}else{if(editing){var roleEdges=global.network.getEdges({from:global.network.getNodes({type_t0:"Ego"})[0].id,to:editing,type:"Role"});$.each(roleEdges,function(index,value){$(".rel-"+value.reltype_main_t0).find('div[data-sub-relationship="'+value.reltype_sub_t0+'"]').addClass("selected").data("selected",!0)})}$(".newNodeBox").addClass("back"),$(".relationship-types-container").addClass("open front"),$(".relationship").css({position:"relative",opacity:0,top:"-200px"}),$(".relationship-type").css({position:"relative",opacity:0,top:"-100px"}),$.each($(".relationship-type"),function(index,value){setTimeout(function(){$(value).transition({opacity:1,top:"0px"},200),$.each($(value).children(".relationship"),function(index,childvalue){setTimeout(function(){$(childvalue).transition({opacity:1,top:0},100)},100+50*index)})},80*index)})}},namegenerator.addToList=function(properties){var card;card=$('<div class="card"><div class="inner-card" data-index="'+properties.to+'"><h4>'+properties.nname_t0+"</h4></div></div>");var list=$("<ul></ul>");$.each(namegenerator.options.variables,function(index,value){value["private"]===!1&&void 0!==properties[value.variable]&&""!==properties[value.variable]&&list.append('<li class="'+properties[value.variable]+'"><strong>'+value.label+"</strong>: "+properties[value.variable]+"</li>")}),card.children(".inner-card").append(list),$(".nameList").append(card)},namegenerator.removeFromList=function(){$(".delete-button").hide();var nodeID=editing;global.network.removeNode(nodeID),$("div[data-index="+editing+"]").addClass("delete");var tempEditing=editing;setTimeout(function(){console.log("removing"),console.log($("div[data-index="+editing+"]").parent()),$("div[data-index="+tempEditing+"]").parent().remove()},700),editing=!1,namegenerator.closeNodeBox()},namegenerator};module.exports=new Namegenerator,module.exports=function(){"use strict";this.nodes=[],this.edges=[];var _this=this;this.addNode=function(properties,ego,force){var reserved_ids;if(force||(force=!1),ego||(ego=!1),reserved_ids=ego?[]:_this.getEgo().reserved_ids,"undefined"!=typeof properties.id&&this.getNode(properties.id)!==!1)return global.tools.notify("Node already exists with id "+properties.id+". Cancelling!",2),!1;if(!force&&-1!==reserved_ids.indexOf(properties.id))return global.tools.notify("Node id "+properties.id+" is already in use with this ego. Cancelling!",2),!1;for(var newNodeID=0;_this.getNode(newNodeID)!==!1||-1!==reserved_ids.indexOf(newNodeID);)newNodeID++;var nodeProperties={id:newNodeID};global.tools.extend(nodeProperties,properties),_this.nodes.push(nodeProperties),reserved_ids.push(newNodeID);var log=new window.CustomEvent("log",{detail:{eventType:"nodeCreate",eventObject:nodeProperties}});window.dispatchEvent(log);var nodeAddedEvent=new window.CustomEvent("nodeAdded",{detail:nodeProperties});window.dispatchEvent(nodeAddedEvent);var unsavedChanges=new window.Event("unsavedChanges");return window.dispatchEvent(unsavedChanges),nodeProperties.id},this.loadNetwork=function(data,overwrite){return data&&data.nodes&&data.edges?(overwrite||(overwrite=!1),overwrite?(_this.nodes=data.nodes,_this.dges=data.edges):(_this.nodes=_this.nodes.concat(data.nodes),_this.edges=_this.edges.concat(data.edges)),!0):(global.tools.notify("Error loading network. Data format incorrect.",1),!1)},this.createEgo=function(properties){if(_this.egoExists()!==!1)return!1;var egoProperties={id:0,type_t0:"Ego",reserved_ids:[0]};global.tools.extend(egoProperties,properties),_this.addNode(egoProperties,!0)},this.getEgo=function(){return 0!==_this.getNodes({type_t0:"Ego"}).length?_this.getNodes({type_t0:"Ego"})[0]:!1},this.egoExists=function(){return _this.getEgo()!==!1?!0:!1},this.addEdge=function(properties){if("undefined"==typeof properties.from||"undefined"==typeof properties.to)return global.tools.notify('ERROR: "To" and "From" must BOTH be defined.',2),!1;if("undefined"!==properties.id&&_this.getEdge(properties.id)!==!1){global.tools.notify("An edge with this id already exists! I'm generating a new one for you.",2);for(var newEdgeID=0;_this.getEdge(newEdgeID)!==!1;)newEdgeID++;properties.id=newEdgeID}for(var position=0;_this.getEdge(position)!==!1;)position++;var edgeProperties={id:position,type:"Default"};global.tools.extend(edgeProperties,properties);var temp,alreadyExists=!1,reversed={};if(reversed=$.extend(!0,{},properties),temp=reversed.to,reversed.to=reversed.from,reversed.from=temp,(_this.getEdges(properties).length>0||_this.getEdges(reversed).length>0)&&(alreadyExists=!0),alreadyExists===!1){_this.edges.push(edgeProperties);var log=new window.CustomEvent("log",{detail:{eventType:"edgeCreate",eventObject:edgeProperties}});window.dispatchEvent(log);var edgeAddedEvent=new window.CustomEvent("edgeAdded",{detail:edgeProperties});window.dispatchEvent(edgeAddedEvent);var unsavedChanges=new window.Event("unsavedChanges");return window.dispatchEvent(unsavedChanges),edgeProperties.id}return global.tools.notify("ERROR: Edge already exists!",2),!1},this.removeEdges=function(edges){_this.removeEdge(edges)},this.removeEdge=function(edge){if(!edge)return!1;var log,edgeRemovedEvent;if("object"==typeof edge&&"undefined"!=typeof edge.length)for(var i=0;i<edge.length;i++)global.tools.removeFromObject(edge[i],_this.edges),log=new window.CustomEvent("log",{detail:{eventType:"edgeRemove",eventObject:edge[i]}}),edgeRemovedEvent=new window.CustomEvent("edgeRemoved",{detail:edge[i]}),window.dispatchEvent(log),window.dispatchEvent(edgeRemovedEvent);else global.tools.removeFromObject(edge,_this.edges),log=new window.CustomEvent("log",{detail:{eventType:"edgeRemove",eventObject:edge}}),edgeRemovedEvent=new window.CustomEvent("edgeRemoved",{detail:edge}),window.dispatchEvent(log),window.dispatchEvent(edgeRemovedEvent);var unsavedChanges=new window.Event("unsavedChanges");return window.dispatchEvent(unsavedChanges),!0},this.removeNode=function(id,preserveEdges){preserveEdges||(preserveEdges=!1),preserveEdges?global.tools.notify("NOTICE: preserving node edges after deletion.",2):this.removeEdge(_this.getNodeEdges(id));for(var nodeRemovedEvent,log,i=0;i<_this.nodes.length;i++)if(_this.nodes[i].id===id)return log=new window.CustomEvent("log",{detail:{eventType:"nodeRemove",eventObject:_this.nodes[i]}}),window.dispatchEvent(log),nodeRemovedEvent=new window.CustomEvent("nodeRemoved",{detail:_this.nodes[i]}),window.dispatchEvent(nodeRemovedEvent),global.tools.removeFromObject(_this.nodes[i],_this.nodes),!0;return!1},this.updateEdge=function(id,properties,callback){if(_this.getEdge(id)===!1||void 0===properties)return!1;var edgeUpdateEvent,log,edge=_this.getEdge(id);global.tools.extend(edge,properties),edgeUpdateEvent=new window.CustomEvent("edgeUpdatedEvent",{detail:edge}),window.dispatchEvent(edgeUpdateEvent),log=new window.CustomEvent("log",{detail:{eventType:"edgeUpdate",eventObject:edge}}),window.dispatchEvent(log);var unsavedChanges=new window.Event("unsavedChanges");window.dispatchEvent(unsavedChanges),callback&&callback()},this.updateNode=function(id,properties,callback){if(this.getNode(id)===!1||void 0===properties)return!1;var nodeUpdateEvent,log,node=this.getNode(id);global.tools.extend(node,properties),nodeUpdateEvent=new window.CustomEvent("nodeUpdatedEvent",{detail:node}),window.dispatchEvent(nodeUpdateEvent),log=new window.CustomEvent("log",{detail:{eventType:"nodeUpdate",eventObject:node}}),window.dispatchEvent(log);var unsavedChanges=new window.Event("unsavedChanges");window.dispatchEvent(unsavedChanges),callback&&callback()},this.getNode=function(id){if(void 0===id)return!1;for(var i=0;i<_this.nodes.length;i++)if(_this.nodes[i].id===id)return _this.nodes[i];return!1},this.getEdge=function(id){if(void 0===id)return!1;for(var i=0;i<_this.edges.length;i++)if(_this.edges[i].id===id)return _this.edges[i];return!1},this.filterObject=function(targetArray,criteria){if(!criteria)return!1;var result=targetArray.filter(function(el){var match=!0;for(var criteriaKey in criteria)void 0!==el[criteriaKey]?el[criteriaKey]!==criteria[criteriaKey]&&(match=!1):match=!1;return match===!0?el:void 0});if("undefined"!=typeof criteria.from&&"undefined"!=typeof criteria.to){var temp,reversed={};reversed=$.extend(!0,{},criteria),temp=reversed.to,reversed.to=reversed.from,reversed.from=temp;var result2=targetArray.filter(function(el){var match=!0;for(var criteriaKey in reversed)void 0!==el[criteriaKey]?el[criteriaKey]!==reversed[criteriaKey]&&(match=!1):match=!1;return match===!0?el:void 0});result=result.concat(result2)}return result},this.getNodes=function(criteria,filter){var results;return results="undefined"!=typeof criteria&&0!==Object.keys(criteria).length?_this.filterObject(_this.nodes,criteria):_this.nodes,filter&&(results=filter(results)),results},this.getEdges=function(criteria,filter){var results;return results="undefined"!=typeof criteria&&0!==Object.keys(criteria).length?_this.filterObject(_this.edges,criteria):_this.edges,filter&&(results=filter(results)),results},this.getNodeInboundEdges=function(nodeID){return _this.getEdges({to:nodeID})},this.getNodeOutboundEdges=function(nodeID){return _this.getEdges({from:nodeID})},this.getNodeEdges=function(nodeID){if(_this.getNode(nodeID)===!1)return!1;var inbound=_this.getNodeInboundEdges(nodeID),outbound=_this.getNodeOutboundEdges(nodeID),concat=inbound.concat(outbound);return concat},this.setProperties=function(object,properties){if("undefined"==typeof object)return!1;if("object"==typeof object&&object.length>0)for(var i=0;i<object.length;i++)$.extend(object[i],properties);else $.extend(object,properties)},this.returnAllNodes=function(){return _this.nodes},this.returnAllEdges=function(){return _this.edges},this.clearGraph=function(){_this.edges=[],_this.nodes=[]},this.createRandomGraph=function(nodeCount,edgeProbability){nodeCount=nodeCount||10,edgeProbability=edgeProbability||.4,global.tools.notify("Creating random graph...",1);for(var i=0;nodeCount>i;i++){var current=i+1;global.tools.notify("Adding node "+current+" of "+nodeCount,2);var nodeOptions={coords:[Math.round(randomBetween(100,window.innerWidth-100)),Math.round(randomBetween(100,window.innerHeight-100))]};this.addNode(nodeOptions)}global.tools.notify("Adding _this.edges.",3),$.each(_this.nodes,function(index){if(randomBetween(0,1)<edgeProbability){var randomFriend=Math.round(randomBetween(0,_this.nodes.length-1));_this.addEdge({from:_this.nodes[index].id,to:_this.nodes[randomFriend].id})}})}};var OrdinalBin=function(){"use strict";var log,ordinalBin={},taskComprehended=!1;ordinalBin.options={targetEl:$(".container"),edgeType:"Dyad",criteria:{from:global.network.getNodes({type_t0:"Ego"})[0].id},variable:{label:"gender_p_t0",values:["Female","Male","Transgender","Don't Know","Won't Answer"]},heading:"Default Heading",subheading:"Default Subheading."};var followup,stageChangeHandler=function(){ordinalBin.destroy()},followupHandler=function(){var followupVal=$(this).data("value"),nodeid=followup,criteria={to:nodeid};global.tools.extend(criteria,ordinalBin.options.criteria);var edge=global.network.getEdges(criteria)[0],followupProperties={};followupProperties[ordinalBin.options.followup.variable]=followupVal,global.tools.extend(edge,followupProperties),global.network.updateEdge(edge.id,edge),$(".followup").hide()};return ordinalBin.destroy=function(){global.tools.notify("Destroying ordinalBin.",0),window.removeEventListener("changeStageStart",stageChangeHandler,!1),$(window.document).off("click",".followup-option",followupHandler);
},ordinalBin.init=function(options){global.tools.extend(ordinalBin.options,options),ordinalBin.options.targetEl.append('<div class="node-question-container"></div>'),$(".node-question-container").append("<h1>"+ordinalBin.options.heading+"</h1>"),$(".node-question-container").append('<p class="lead">'+ordinalBin.options.subheading+"</p>"),$(".node-question-container").append('<div class="node-bucket"></div>'),"undefined"!=typeof ordinalBin.options.followup&&($(".node-question-container").append('<div class="followup"><h2>'+ordinalBin.options.followup.prompt+"</h2></div>"),$.each(ordinalBin.options.followup.values,function(index,value){$(".followup").append('<span class="btn btn-primary btn-block followup-option" data-value="'+value.value+'">'+value.label+"</span>")})),ordinalBin.options.targetEl.append('<div class="node-bin-container"></div>');var binNumber=ordinalBin.options.variable.values.length;$.each(ordinalBin.options.variable.values,function(index,value){var newBin=$('<div class="ord-node-bin size-'+binNumber+" d"+index+'" data-index="'+index+'"><h1>'+value.label+'</h1><div class="active-node-list"></div></div>');newBin.data("index",index),$(".node-bin-container").append(newBin),$(".d"+index).droppable({accept:".draggable",drop:function(event,ui){console.log("dropped");var dropped=ui.draggable,droppedOn=$(this);ordinalBin.options.variable.values[index].value>0&&($(".followup").show(),followup=$(dropped).data("node-id")),console.log(droppedOn.children(".active-node-list")),console.log(dropped),dropped.css({position:"inherit"}),droppedOn.children(".active-node-list").append(dropped),$(dropped).appendTo(droppedOn.children(".active-node-list"));var properties={};properties[ordinalBin.options.variable.label]=ordinalBin.options.variable.values[index].value;var edgeID=global.network.getEdges({from:global.network.getNodes({type_t0:"Ego"})[0].id,to:$(dropped).data("node-id"),type:ordinalBin.options.edgeType})[0].id;global.network.updateEdge(edgeID,properties),$.each($(".ord-node-bin"),function(oindex){var length=$(".d"+oindex).children(".active-node-list").children().length;if(length>0){var noun="people";1===length&&(noun="person"),$(".d"+oindex+" p").html(length+" "+noun+".")}else $(".d"+oindex+" p").html("(Empty)")});var el=$(".d"+index);setTimeout(function(){el.transition({background:el.data("oldBg")},200,"ease")},0),$(".draggable").draggable({cursor:"pointer",revert:"invalid",start:function(){if(console.log($(this).css("top")),"auto"!==$(this).css("top")&&"0px"!==$(this).css("top")?(console.log("has class"),$(this).css({position:"absolute"})):(console.log("not"),$(this).css({position:"relative"})),taskComprehended===!1){var eventProperties={stage:global.session.currentStage(),timestamp:new Date};log=new window.CustomEvent("log",{detail:{eventType:"taskComprehended",eventObject:eventProperties}}),window.dispatchEvent(log),taskComprehended=!0}},stop:function(){$(this).css({position:"inerit"})}})},over:function(){$(this).data("oldBg",$(this).css("background-color")),$(this).stop().transition({background:"rgba(255, 193, 0, 1.0)"},400,"ease")},out:function(){$(this).stop().transition({background:$(this).data("oldBg")},500,"ease")}})});var edges=global.network.getEdges(ordinalBin.options.criteria);$.each(edges,function(index,value){var dyadEdge;"Dyad"!==ordinalBin.options.criteria.type&&(dyadEdge=global.network.getEdges({from:value.from,to:value.to,type:"Dyad"})[0]),void 0!==value[ordinalBin.options.variable.label]&&""!==value[ordinalBin.options.variable.label]?(index="error",$.each(ordinalBin.options.variable.values,function(vindex,vvalue){value[ordinalBin.options.variable.label]===vvalue.value&&(index=vindex)}),"Dyad"!==ordinalBin.options.criteria.type?$(".d"+index).children(".active-node-list").append('<div class="node-bucket-item draggable" data-node-id="'+value.to+'">'+dyadEdge.nname_t0+"</div>"):$(".d"+index).children(".active-node-list").append('<div class="node-bucket-item draggable" data-node-id="'+value.to+'">'+value.nname_t0+"</div>")):"Dyad"!==ordinalBin.options.criteria.type?$(".node-bucket").append('<div class="node-bucket-item draggable" data-node-id="'+value.to+'">'+dyadEdge.nname_t0+"</div>"):$(".node-bucket").append('<div class="node-bucket-item draggable" data-node-id="'+value.to+'">'+value.nname_t0+"</div>")}),$(".draggable").draggable({cursor:"pointer",revert:"invalid",start:function(){if($(this).css({position:"relative"}),taskComprehended===!1){var eventProperties={stage:global.session.currentStage(),timestamp:new Date};log=new window.CustomEvent("log",{detail:{eventType:"taskComprehended",eventObject:eventProperties}}),window.dispatchEvent(log),taskComprehended=!0}},stop:function(){$(this).css({position:"inerit"})}}),window.addEventListener("changeStageStart",stageChangeHandler,!1),$(window.document).on("click",".followup-option",followupHandler)},ordinalBin};module.exports=new OrdinalBin;var RoleRevisit=function(){"use strict";var roleRevisit={};roleRevisit.options={nodeType:"Alter",edgeType:"Dyad",targetEl:$(".container"),variables:[],heading:"This is a default heading",subheading:"And this is a default subheading"};var nodeBoxOpen=!1,editing=!1,roles={Friend:["Best Friend","Friend","Ex-friend","Other type"],"Family / Relative":["Parent / Guardian","Brother / Sister","Grandparent","Other Family","Chosen Family"],"Romantic / Sexual Partner":["Boyfriend / Girlfriend","Ex-Boyfriend / Ex-Girlfriend","Booty Call / Fuck Buddy / Hook Up","One Night Stand","Other type of Partner"],"Acquaintance / Associate":["Coworker / Colleague","Classmate","Roommate","Friend of a Friend","Neighbor","Other"],"Other Support / Source of Advice":["Teacher / Professor","Counselor / Therapist","Community Agency Staff","Religious Leader","Mentor","Coach","Other"],"Drug Use":["Someone you use drugs with","Someone you buy drugs from"],Other:["Other relationship"]},roleClickHandler=function(){$(this).data("selected")===!0?($(this).data("selected",!1),$(this).removeClass("selected")):($(this).data("selected",!0),$(this).addClass("selected"))},stageChangeHandler=function(){roleRevisit.destroy()},cardClickHandler=function(e){console.log("card click"),console.log(e);var index=$(this).data("index");console.log(index),editing=index;var roleCount=global.network.getEdges({from:global.network.getNodes({type_t0:"Ego"})[0].id,to:editing,type:"Role"}).length;$('div[data-index="'+index+'"]').children().children(".role-count").html(roleCount+" roles selected.");var roleEdges=global.network.getEdges({from:global.network.getNodes({type_t0:"Ego"})[0].id,to:editing,type:"Role"});$.each(roleEdges,function(index,value){$(".rel-"+value.reltype_main_t0).find('div[data-sub-relationship="'+value.reltype_sub_t0+'"]').addClass("selected").data("selected",!0)}),global.network.removeEdges(global.network.getEdges({from:global.network.getNodes({type_t0:"Ego"})[0].id,to:editing,type:"Role"})),roleRevisit.openNodeBox()},submitFormHandler=function(){var el=$("div[data-index="+editing+"]");el.stop().transition({background:"#1ECD97"},400,"ease"),$.each($(".relationship.selected"),function(){var edgeProperties={type:"Role",from:global.network.getNodes({type_t0:"Ego"})[0].id,to:editing,reltype_main_t0:$(this).parent(".relationship-type").data("main-relationship"),reltype_sub_t0:$(this).data("sub-relationship")};global.network.addEdge(edgeProperties)}),$(".relationship").removeClass("selected");var roleCount=global.network.getEdges({from:global.network.getNodes({type_t0:"Ego"})[0].id,to:editing,type:"Role"}).length;$('div[data-index="'+editing+'"]').children().children(".role-count").html(roleCount+" roles selected."),roleRevisit.closeNodeBox()};return roleRevisit.openNodeBox=function(){$(".content").addClass("blurry"),$(".relationship-types-container").addClass("open"),nodeBoxOpen=!0},roleRevisit.closeNodeBox=function(){$(".content").removeClass("blurry"),$(".relationship-types-container").removeClass("open"),setTimeout(function(){}),nodeBoxOpen=!1},roleRevisit.addToList=function(properties){var card;card=$('<div class="card" data-index="'+properties.to+'"><h4>'+properties.nname_t0+"</h4></div>");var list=$("<ul></ul>");list.append('<li class="'+properties.fname_t0+'"><strong>First Name</strong>: '+properties.fname_t0+"</li>"),list.append('<li class="'+properties.lname_t0+'"><strong>Last Name</strong>: '+properties.lname_t0+"</li>");var roles=global.network.getEdges({from:global.network.getNodes({type_t0:"Ego"})[0].id,to:properties.to,type:"Role"}),roleString="";$.each(roles,function(index,value){roleString+=" "+value.reltype_sub_t0+","}),roleString=roleString.substring(0,roleString.length-1),list.append("<li><strong>Roles</strong>: "+roleString+"</li>"),card.append(list),$(".nameList").append(card)},roleRevisit.destroy=function(){global.tools.notify("Destroying roleRevisit.",0),$(window.document).off("click",".card",cardClickHandler),window.removeEventListener("changeStageStart",stageChangeHandler,!1),$(".relationship-types-container").remove(),$(window.document).off("click",".relationship",roleClickHandler),$(window.document).off("click",".relationship-close-button",roleRevisit.toggleRelationshipBox)},roleRevisit.init=function(options){global.tools.extend(roleRevisit.options,options);var title=$('<h1 class="text-center"></h1>').html(roleRevisit.options.heading);roleRevisit.options.targetEl.append(title);var subtitle=$('<p class="lead text-center"></p>').html(roleRevisit.options.subheading);roleRevisit.options.targetEl.append(subtitle);var roleBox=$('<div class="relationship-types-container"><button class="btn btn-primary relationship-close-button">Close</button></div>');$("body").append(roleBox);var counter=0;$.each(roles,function(index){$(".relationship-types-container").append('<div class="relationship-type rel-'+counter+" c"+counter+'" data-main-relationship="'+counter+'"><h1>'+index+"</h1></div>"),$.each(roles[index],function(relIndex,relValue){$(".rel-"+counter).append('<div class="relationship" data-sub-relationship="'+relValue+'">'+relValue+"</div>")}),counter++});var nodeContainer=$('<div class="node-container"></div>');roleRevisit.options.targetEl.append(nodeContainer);var nameList=$('<div class="table nameList"></div>');$(".node-container").append(nameList),window.addEventListener("changeStageStart",stageChangeHandler,!1),$(window.document).on("click",".card",cardClickHandler),$(window.document).on("click",".relationship",roleClickHandler),$(window.document).on("click",".relationship-close-button",submitFormHandler)},roleRevisit};module.exports=new RoleRevisit;var Session=function(){"use strict";function saveFile(path){var data=JSON.stringify(session.sessionData,void 0,2),fs=require("fs");fs.writeFile(path,data)}function clickDownloadInput(){$("#save").prop("nwsaveas",session.returnSessionID()+"_"+Math.floor(Date.now()/1e3)+".json");var event=window.document.createEvent("MouseEvents");event.initMouseEvent("click"),window.document.getElementById("save").dispatchEvent(event)}function sessionNextHandler(){global.session.nextStage()}function sessionPreviousHandler(){global.session.prevStage()}var session={},currentStage=0,content=$("#content");session.id=0,session.sessionData={};var lastSaveTime,saveTimer;return session.options={fnBeforeStageChange:function(oldStage,newStage){var eventProperties={stage:currentStage,timestamp:new Date},log=new window.CustomEvent("log",{detail:{eventType:"stageCompleted",eventObject:eventProperties}});window.dispatchEvent(log);var changeStageStartEvent=new window.CustomEvent("changeStageStart",{detail:{oldStage:oldStage,newStage:newStage}});window.dispatchEvent(changeStageStartEvent)},fnAfterStageChange:function(oldStage,newStage){session.sessionData.sessionParameters.stage=newStage;var changeStageEndEvent=new window.CustomEvent("changeStageEnd",{detail:{oldStage:oldStage,newStage:newStage}});window.dispatchEvent(changeStageEndEvent),currentStage+1===session.stages.length?$(".arrow-next").hide():0===currentStage?($(".arrow-prev").hide(),$(".arrow-next").attr("disabled","disabled")):($(".arrow-next").show().removeAttr("disabled"),$(".arrow-prev").show())}},session.loadProtocol=function(){var path=require("path"),studyPath=path.normalize("../protocols/"+global.studyProtocol+"/protocol.js"),study=require(studyPath);if(session.parameters=session.registerData("sessionParameters"),session.updateSessionData({sessionParameters:study.sessionParameters}),session.stages=study.stages,$("head").append('<link rel="stylesheet" href="protocols/'+global.studyProtocol+'/css/style.css" type="text/css" />'),session.skipFunctions=study.skipFunctions,!study.sessionParameters.name)throw new Error("Study protocol must have a 'name' under sessionParameters.");session.name=study.sessionParameters.name,global.dataStore.init(function(sessionid){session.id=sessionid,global.dataStore.load(function(data){console.log(data),console.log(study),session.updateSessionData(data,function(){session.sessionData.nodes&&session.sessionData.edges&&global.network.loadNetwork({nodes:session.sessionData.nodes,edges:session.sessionData.edges}),"undefined"!=typeof session.sessionData.sessionParameters.stage?session.goToStage(session.sessionData.sessionParameters.stage):session.goToStage(0)})},session.id)});var stagesMenu=global.menu.addMenu("Stages","hi-icon-list");$.each(session.stages,function(index,value){global.menu.addItem(stagesMenu,value.label,null,function(){setTimeout(function(){session.goToStage(index)},500)})})},session.init=function(callback){global.tools.notify("Session initialising.",1),$(".arrow-next").on("click",sessionNextHandler),$(".arrow-prev").on("click",sessionPreviousHandler),window.addEventListener("changeStageStart",function(){$(".loader").transition({opacity:1})},!1),window.addEventListener("changeStageEnd",function(){$(".loader").transition({opacity:0})},!1),window.document.getElementById("save").addEventListener("change",function(){saveFile(this.value)});var Network=require("../js/network");global.network=new Network,window.addEventListener("unsavedChanges",function(){session.saveManager()},!1);var sessionMenu=global.menu.addMenu("Session","hi-icon-cog");global.menu.addItem(sessionMenu,"Reset Session","fa-undo",function(){window.BootstrapDialog.show({type:window.BootstrapDialog.TYPE_DANGER,title:"",message:"<h3>Are you sure you want to reset the session?</h3> <p><strong>IMPORTANT:</strong> This will delete all data.",buttons:[{label:"Continue",cssClass:"btn-modal-success",action:function(){global.dataStore.deleteDocument(session.reset)}},{label:"Cancel",cssClass:"btn-modal-danger",action:function(dialogItself){dialogItself.close()}}]})}),global.menu.addItem(sessionMenu,"Download Data","fa-download",function(){clickDownloadInput()}),global.menu.addItem(sessionMenu,"Purge Database","fa-trash",function(){window.BootstrapDialog.show({type:window.BootstrapDialog.TYPE_DANGER,title:"",message:"<h3>Are you sure you want to purge the database?</h3><p><strong>IMPORTANT:</strong> This will delete all data.",buttons:[{label:"Continue",cssClass:"btn-modal-success",action:function(){global.dataStore.reset(session.reset)}},{label:" Cancel",cssClass:"btn-modal-danger",action:function(dialogItself){dialogItself.close()}}]})}),global.menu.addItem(sessionMenu,"Quit Network Canvas","fa-sign-out",function(){window.close()}),callback&&callback()},session.downloadData=function(){var filename=session.returnSessionID()+".json",text=JSON.stringify(session.sessionData,void 0,2),pom=document.createElement("a");pom.setAttribute("href","data:text/plain;charset=utf-8,"+encodeURIComponent(text)),pom.setAttribute("download",filename),pom.click()},session.reset=function(){global.tools.notify("Resetting session.",2),session.id=0,session.currentStage=0;var _window=global.gui.Window.get();_window.reloadDev()},session.saveManager=function(){clearTimeout(saveTimer),saveTimer=setTimeout(session.saveData,3e3)},session.updateSessionData=function(data,callback){global.tools.notify("Updating user data.",2),global.tools.notify("Using the following to update:",1),global.tools.notify(data,1),global.tools.notify("session.sessionData is:",1),global.tools.notify(session.sessionData,1),$.extend(!0,session.sessionData,data),global.tools.notify("Combined output is:",1),global.tools.notify(session.sessionData,1);var newDataLoaded=new window.Event("newDataLoaded");window.dispatchEvent(newDataLoaded);var unsavedChanges=new window.Event("unsavedChanges");window.dispatchEvent(unsavedChanges),callback&&callback()},session.returnSessionID=function(){return session.id},session.saveData=function(){if(session.sessionData.nodes=global.network.getNodes(),session.sessionData.edges=global.network.getEdges(),global.dataStore.initialised())global.dataStore.save(session.sessionData,session.returnSessionID());else{global.tools.notify("Tried to save, but datastore not initaialised. Delaying.",1);var unsavedChanges=new window.Event("unsavedChanges");window.dispatchEvent(unsavedChanges)}lastSaveTime=new Date},session.goToStage=function(stage){if("undefined"==typeof stage||"undefined"==typeof session.stages[stage])return!1;if(session.stages[stage].skip){var outcome=session.stages[stage].skip();if(outcome===!0)return console.log("Skipping because skip condition was met."),stage>currentStage?session.goToStage(stage+1):session.goToStage(stage-1),!1}global.tools.notify("Session is moving to stage "+stage,3);var eventProperties={stage:stage,timestamp:new Date},log=new window.CustomEvent("log",{detail:{eventType:"stageVisible",eventObject:eventProperties}});window.dispatchEvent(log),session.options.fnBeforeStageChange(currentStage,stage);var newStage=stage,stagePath="./protocols/"+global.studyProtocol+"/stages/"+session.stages[stage].page;content.transition({opacity:"0"},400,"easeInSine").promise().done(function(){content.load(stagePath,function(){content.transition({opacity:"1"},400,"easeInSine")})});var oldStage=currentStage;currentStage=newStage,session.options.fnAfterStageChange(oldStage,currentStage);var unsavedChanges=new window.Event("unsavedChanges");window.dispatchEvent(unsavedChanges)},session.nextStage=function(){session.goToStage(currentStage+1)},session.prevStage=function(){session.goToStage(currentStage-1)},session.registerData=function(dataKey,isArray){global.tools.notify('A script requested a data store be registered with the key "'+dataKey+'".',2),void 0===session.sessionData[dataKey]?(global.tools.notify('Key named "'+dataKey+'" was not already registered. Creating.',1),isArray?session.sessionData[dataKey]=[]:session.sessionData[dataKey]={}):global.tools.notify("A data store with this key already existed. Returning a reference.",1);var unsavedChanges=new window.Event("unsavedChanges");return window.dispatchEvent(unsavedChanges),session.sessionData[dataKey]},session.addData=function(dataKey,newData,append){append||(append=!1),append===!0?session.sessionData[dataKey].push(newData):global.tools.extend(session.sessionData[dataKey],newData),global.tools.notify('Adding data to key "'+dataKey+'".',2),global.tools.notify(newData,1);var unsavedChanges=new window.Event("unsavedChanges");window.dispatchEvent(unsavedChanges)},session.currentStage=function(){return currentStage},session.returnData=function(dataKey){return dataKey&&"undefined"!=typeof session.sessionData[dataKey]?session.sessionData[dataKey]:session.sessionData},session};module.exports=new Session;var Sociogram=function(){"use strict";function padText(text,container,amount){for(;1.1*text.width()<container.width()-2*amount;)text.fontSize(1.1*text.fontSize()),text.y((container.height()-text.height())/2);text.setX(container.getX()-text.getWidth()/2),text.setY(container.getY()-text.getHeight()/1.8)}var stage,circleLayer,edgeLayer,nodeLayer,uiLayer,log,sociogram={},selectedNodes=[],menuOpen=!1,cancelKeyBindings=!1,taskComprehended=!1,colors={blue:"#0174DF",placidblue:"#83b5dd",violettulip:"#9B90C8",hemlock:"#9eccb3",paloma:"#aab1b0",freesia:"#ffd600",cayenne:"#c40000",celosiaorange:"#f47d44",sand:"#ceb48d",dazzlingblue:"#006bb6",edge:"#e85657",selected:"gold"};sociogram.settings={network:global.network,defaultNodeSize:35,defaultNodeColor:colors.blue,defaultEdgeColor:colors.edge,concentricCircleColor:"#ffffff",concentricCircleNumber:4,criteria:{from:global.network.getNodes({type_t0:"Ego"})[0].id},nodeTypes:[{name:"Person",color:colors.blue},{name:"OnlinePerson",color:colors.hemlock},{name:"Organisation",color:colors.cayenne},{name:"Professional",color:colors.violettulip}]};var nodeAddedHandler=function(e){sociogram.addNode(e.detail)},edgeAddedHandler=function(e){"undefined"!=typeof e.detail.from&&e.detail.from!==sociogram.settings.network.getNodes({type_t0:"Ego"})[0].id&&sociogram.addEdge(e.detail)},nodeRemovedHandler=function(e){sociogram.removeNode(e.detail)},edgeRemovedHandler=function(e){sociogram.removeEdge(e.detail)},closePopoverHandler=function(){var buttonOffset=$(".info-button").offset(),currentOffset=$(".sociogram-title").offset();$(".sociogram-title").data("oldPos",currentOffset),$(".sociogram-title").css({position:"absolute"}),$(".sociogram-title").offset(currentOffset),$(".sociogram-title").children().hide(),$(".sociogram-title").addClass("closed"),$(".sociogram-title").offset(buttonOffset),setTimeout(function(){$(".sociogram-popover").hide(),$(".info-button").css("visibility","visible")},500)},openPopoverHandler=function(){$(".info-button").css("visibility","hidden"),$(".sociogram-popover").show(),$(".sociogram-title").offset($(".sociogram-title").data("oldPos")),$(".sociogram-title").removeClass("closed"),setTimeout(function(){$(".sociogram-title").children().show()},500)},keyPressHandler=function(e){cancelKeyBindings||(menuOpen||($(".new-node-form").addClass("node-form-open"),$(".content").addClass("blurry"),menuOpen=!0,$(".name-box").focus()),8!==e.which||$(e.target).is("input, textarea, div")||e.preventDefault())},stageChangeHandler=function(){sociogram.destroy()};return sociogram.init=function(userSettings){global.tools.notify("Sociogram initialising.",1),global.tools.extend(sociogram.settings,userSettings),$('<div class="sociogram-title"><h3>'+sociogram.settings.heading+'</h3><p class="lead">'+sociogram.settings.subheading+"</p></div>").insertBefore("#kineticCanvas"),sociogram.initKinetic(),window.addEventListener("nodeAdded",nodeAddedHandler,!1),window.addEventListener("edgeAdded",edgeAddedHandler,!1),window.addEventListener("nodeRemoved",nodeRemovedHandler,!1),window.addEventListener("edgeRemoved",edgeRemovedHandler,!1),window.addEventListener("changeStageStart",stageChangeHandler,!1),$(".close-popover").on("click",closePopoverHandler),$(".info-button").on("click",openPopoverHandler),console.log(sociogram);for(var criteriaEdges=sociogram.settings.network.getEdges(sociogram.settings.criteria),i=0;i<criteriaEdges.length;i++){var dyadEdge=sociogram.settings.network.getEdges({from:criteriaEdges[i].from,to:criteriaEdges[i].to,type:"Dyad"})[0],newNode=sociogram.addNode(dyadEdge);if("Select"===sociogram.settings.mode)if(sociogram.settings.variable){var properties={from:sociogram.settings.network.getNodes({type_t0:"Ego"})[0].id,to:criteriaEdges[i].to};properties[sociogram.settings.variable]=1,sociogram.settings.network.getEdges(properties).length>0&&(newNode.children[0].stroke(colors.selected),nodeLayer.draw())}else sociogram.settings.network.getEdges({from:sociogram.settings.network.getNodes({type_t0:"Ego"})[0].id,to:criteriaEdges[i].to,type:sociogram.settings.edgeType}).length>0&&(newNode.children[0].stroke(colors.selected),nodeLayer.draw())}setTimeout(function(){sociogram.drawUIComponents()},0);var edges,edgeProperties;"Edge"===sociogram.settings.mode?(edgeProperties={type:sociogram.settings.edgeType},edges=sociogram.settings.network.getEdges(edgeProperties,function(results){var filteredResults=[];return $.each(results,function(index,value){value.from!==sociogram.settings.network.getEgo().id&&value.to!==sociogram.settings.network.getEgo().id&&filteredResults.push(value)}),filteredResults}),$.each(edges,function(index,value){sociogram.addEdge(value)})):"Select"===sociogram.settings.mode||"Update"===sociogram.settings.mode?(edgeProperties={},edgeProperties=sociogram.settings.showEdge?{type:sociogram.settings.showEdge}:{type:"Dyad"},edges=sociogram.settings.network.getEdges(edgeProperties,function(results){var filteredResults=[];return $.each(results,function(index,value){value.from!==sociogram.settings.network.getNodes({type_t0:"Ego"})[0].id&&value.to!==sociogram.settings.network.getNodes({type_t0:"Ego"})[0].id&&filteredResults.push(value)}),filteredResults}),$.each(edges,function(index,value){sociogram.addEdge(value)})):"Position"===sociogram.settings.mode},sociogram.getSelectedNodes=function(){return selectedNodes},sociogram.destroy=function(){console.log("sociogram being destroyed"),$(".new-node-form").remove(),window.removeEventListener("nodeAdded",nodeAddedHandler,!1),window.removeEventListener("edgeAdded",edgeAddedHandler,!1),window.removeEventListener("nodeRemoved",nodeRemovedHandler,!1),window.removeEventListener("edgeRemoved",edgeRemovedHandler,!1),window.removeEventListener("changeStageStart",stageChangeHandler,!1),$(window.document).off("keypress",keyPressHandler),$(".close-popover").off("click",closePopoverHandler),$(".info-button").off("click",openPopoverHandler)},sociogram.resetPositions=function(){var dyadEdges=sociogram.settings.network.getEdges({type:"Dyad"});$.each(dyadEdges,function(index){sociogram.settings.network.updateEdge(dyadEdges[index].id,{coords:[]})})},sociogram.addNode=function(options){global.tools.notify("Sociogram is creating a node.",2),console.log(options);for(var nodeShape,nodeID=0;sociogram.settings.network.getNode(nodeID)!==!1;)nodeID++;var dragStatus=!1;("Position"===sociogram.settings.mode||"Edge"===sociogram.settings.mode)&&(dragStatus=!0),options.label=options.nname_t0;var nodeOptions={coords:[$(window).width()+50,100],id:nodeID,label:"Undefined",size:sociogram.settings.defaultNodeSize,color:"rgb(0,0,0)",strokeWidth:4,draggable:dragStatus,dragDistance:20};global.tools.extend(nodeOptions,options),nodeOptions.id=parseInt(nodeOptions.id,10),nodeOptions.type="Person",nodeOptions.x=nodeOptions.coords[0],nodeOptions.y=nodeOptions.coords[1];var nodeGroup=new Konva.Group(nodeOptions);switch(nodeOptions.type){case"Person":nodeShape=new Konva.Circle({radius:nodeOptions.size,fill:nodeOptions.color,stroke:"white",strokeWidth:nodeOptions.strokeWidth});break;case"Organisation":nodeShape=new Konva.Rect({width:2*nodeOptions.size,height:2*nodeOptions.size,fill:nodeOptions.color,stroke:sociogram.calculateStrokeColor(nodeOptions.color),strokeWidth:nodeOptions.strokeWidth});break;case"OnlinePerson":nodeShape=new Konva.RegularPolygon({sides:3,fill:nodeOptions.color,radius:1.2*nodeOptions.size,stroke:sociogram.calculateStrokeColor(nodeOptions.color),strokeWidth:nodeOptions.strokeWidth});break;case"Professional":nodeShape=new Konva.Star({numPoints:6,fill:nodeOptions.color,innerRadius:nodeOptions.size-nodeOptions.size/3,outerRadius:nodeOptions.size+nodeOptions.size/3,stroke:sociogram.calculateStrokeColor(nodeOptions.color),strokeWidth:nodeOptions.strokeWidth})}var nodeLabel=new Konva.Text({text:nodeOptions.label,fontFamily:"Lato",fill:"white",align:"center",fontStyle:500});if(global.tools.notify("Putting node "+nodeOptions.label+" at coordinates x:"+nodeOptions.coords[0]+", y:"+nodeOptions.coords[1],2),nodeGroup.on("dragstart",function(){if(taskComprehended===!1){var eventProperties={stage:global.session.currentStage(),timestamp:new Date};log=new window.CustomEvent("log",{detail:{eventType:"taskComprehended",eventObject:eventProperties}}),window.dispatchEvent(log),taskComprehended=!0}global.tools.notify("dragstart",1),this.attrs.oldx=this.attrs.x,this.attrs.oldy=this.attrs.y,this.moveToTop(),nodeLayer.draw()}),nodeGroup.on("dragmove",function(){if(taskComprehended===!1){var eventProperties={stage:global.session.currentStage(),timestamp:new Date};log=new window.CustomEvent("log",{detail:{eventType:"taskComprehended",eventObject:eventProperties}}),window.dispatchEvent(log),taskComprehended=!0}global.tools.notify("Dragmove",0);var dragNode=nodeOptions.id;$.each(edgeLayer.children,function(index,value){if(value.attrs.from.id===dragNode||value.attrs.to.id===dragNode){var points=[sociogram.getNodeByID(value.attrs.from.id).getX(),sociogram.getNodeByID(value.attrs.from.id).getY(),sociogram.getNodeByID(value.attrs.to.id).getX(),sociogram.getNodeByID(value.attrs.to.id).getY()];value.attrs.points=points}}),edgeLayer.draw()}),nodeGroup.on("tap click",function(){if(taskComprehended===!1){var eventProperties={stage:global.session.currentStage(),timestamp:new Date};log=new window.CustomEvent("log",{detail:{eventType:"taskComprehended",eventObject:eventProperties}}),window.dispatchEvent(log),taskComprehended=!0}log=new window.CustomEvent("log",{detail:{eventType:"nodeClick",eventObject:this.attrs.id}});var currentNode=this;if(window.dispatchEvent(log),"Select"===sociogram.settings.mode){var edge;if(sociogram.settings.variable){var properties={},currentValue=sociogram.settings.network.getEdge(currentNode.attrs.id)[sociogram.settings.variable];0===currentValue||"undefined"==typeof currentValue?(properties[sociogram.settings.variable]=1,currentNode.children[0].stroke(colors.selected)):(properties[sociogram.settings.variable]=0,currentNode.children[0].stroke("white")),sociogram.settings.network.setProperties(sociogram.settings.network.getEdge(currentNode.attrs.id),properties)}else sociogram.settings.network.getEdges({type:sociogram.settings.edgeType,from:sociogram.settings.network.getEgo().id,to:this.attrs.to}).length>0?(this.children[0].stroke("white"),sociogram.settings.network.removeEdge(sociogram.settings.network.getEdges({type:sociogram.settings.edgeType,from:sociogram.settings.network.getEgo().id,to:this.attrs.to})[0])):(edge={from:sociogram.settings.network.getEgo().id,to:this.attrs.to,type:sociogram.settings.edgeType},"undefined"!=typeof sociogram.settings.variables&&$.each(sociogram.settings.variables,function(index,value){edge[value.label]=value.value}),this.children[0].stroke(colors.selected),sociogram.settings.network.addEdge(edge))}else if("Update"===sociogram.settings.mode)console.log(currentNode),-1===selectedNodes.indexOf(currentNode)?(selectedNodes.push(currentNode.attrs.id),currentNode.children[0].stroke(colors.selected)):(selectedNodes.remove(currentNode.attrs.id),currentNode.children[0].stroke("white")),console.log(selectedNodes);else if("Edge"===sociogram.settings.mode){if(selectedNodes[0]===this)return!1;if(selectedNodes.push(this),2===selectedNodes.length){selectedNodes[1].children[0].stroke("white"),selectedNodes[0].children[0].stroke("white");var edgeProperties={from:selectedNodes[0].attrs.to,to:selectedNodes[1].attrs.to,type:sociogram.settings.edgeType};edgeProperties[sociogram.settings.variables[0]]="perceived",sociogram.settings.network.addEdge(edgeProperties)===!1&&(global.tools.notify("Sociogram removing edge.",2),sociogram.settings.network.removeEdge(sociogram.settings.network.getEdges(edgeProperties))),selectedNodes=[],nodeLayer.draw()}else this.children[0].stroke(colors.selected),nodeLayer.draw()}this.moveToTop(),nodeLayer.draw()}),nodeGroup.on("dragend",function(){global.tools.notify("dragend",1);var from={},to={};from.x=this.attrs.oldx,from.y=this.attrs.oldy,to.x=this.attrs.x,to.y=this.attrs.y;var eventObject={from:from,to:to},currentNode=this;log=new window.CustomEvent("log",{detail:{eventType:"nodeMove",eventObject:eventObject}}),window.dispatchEvent(log),sociogram.settings.network.setProperties(sociogram.settings.network.getEdge(currentNode.attrs.id),{coords:[currentNode.attrs.x,currentNode.attrs.y]}),delete this.attrs.oldx,delete this.attrs.oldy}),padText(nodeLabel,nodeShape,10),nodeGroup.add(nodeShape),nodeGroup.add(nodeLabel),nodeLayer.add(nodeGroup),setTimeout(function(){nodeLayer.draw()},0),!options.coords||0===options.coords.length){var tween=new Konva.Tween({node:nodeGroup,x:$(window).width()-150,y:100,duration:.7,easing:Konva.Easings.EaseOut});tween.play(),sociogram.settings.network.setProperties(sociogram.settings.network.getNode(nodeOptions.id),{
coords:[$(window).width()-150,100]})}return nodeGroup},sociogram.debug=function(){console.log(sociogram.settings),console.log(sociogram.settings.network)},sociogram.addEdge=function(properties){sociogram.debug(),global.tools.notify("Sociogram is adding an edge.",2),console.log(properties);var toObject=sociogram.settings.network.getEdges({from:sociogram.settings.network.getEgo().id,to:properties.to,type:"Dyad"})[0],fromObject=sociogram.settings.network.getEdges({from:sociogram.settings.network.getEgo().id,to:properties.from,type:"Dyad"})[0];console.log(toObject),console.log(fromObject),console.log(sociogram.settings.network.getEgo());var points=[fromObject.coords[0],fromObject.coords[1],toObject.coords[0],toObject.coords[1]],edge=new Konva.Line({strokeWidth:4,opacity:1,stroke:sociogram.settings.defaultEdgeColor,from:fromObject,to:toObject,points:points});return edgeLayer.add(edge),setTimeout(function(){edgeLayer.draw()},0),nodeLayer.draw(),global.tools.notify("Created Edge between "+fromObject.label+" and "+toObject.label,"success",2),!0},sociogram.removeEdge=function(properties){var toNode=sociogram.settings.network.getEdges({from:sociogram.settings.network.getEgo().id,to:properties.to,type:"Dyad"})[0],fromNode=sociogram.settings.network.getEdges({from:sociogram.settings.network.getEgo().id,to:properties.from,type:"Dyad"})[0];global.tools.notify("Removing edge."),$.each(sociogram.getKineticEdges(),function(index,value){void 0!==value&&(value.attrs.from===fromNode&&value.attrs.to===toNode||value.attrs.from===toNode&&value.attrs.to===fromNode)&&(edgeLayer.children[index].remove(),edgeLayer.draw())})},sociogram.removeNode=function(){console.log("removenode kinetic")},sociogram.clearGraph=function(){edgeLayer.removeChildren(),edgeLayer.clear(),nodeLayer.removeChildren(),nodeLayer.clear()},sociogram.initKinetic=function(){stage=new Konva.Stage({container:"kineticCanvas",width:window.innerWidth,height:window.innerHeight}),circleLayer=new Konva.Layer,nodeLayer=new Konva.Layer,edgeLayer=new Konva.Layer,uiLayer=new Konva.Layer,stage.add(circleLayer),stage.add(edgeLayer),stage.add(nodeLayer),stage.add(uiLayer),global.tools.notify("Konva stage initialised.",1)},sociogram.drawUIComponents=function(){for(var circleFills,circleLines,currentColor=sociogram.settings.concentricCircleColor,totalHeight=window.innerHeight-sociogram.settings.defaultNodeSize,currentOpacity=.1,i=0;i<sociogram.settings.concentricCircleNumber;i++){var ratio=1-i/sociogram.settings.concentricCircleNumber,currentRadius=totalHeight/2*ratio;circleLines=new Konva.Circle({x:window.innerWidth/2,y:window.innerHeight/2,radius:currentRadius,stroke:"white",strokeWidth:1.5,opacity:0}),circleFills=new Konva.Circle({x:window.innerWidth/2,y:window.innerHeight/2,radius:currentRadius,fill:currentColor,opacity:currentOpacity,strokeWidth:0}),currentOpacity+=(.3-currentOpacity)/sociogram.settings.concentricCircleNumber,circleLayer.add(circleFills),circleLayer.add(circleLines)}circleLayer.draw(),uiLayer.draw(),global.tools.notify("User interface initialised.",1)},sociogram.initNewNodeForm=function(){var form=$('<div class="new-node-form"></div>'),innerForm=$('<div class="new-node-inner"></div>');form.append(innerForm),innerForm.append("<h1>Add a new contact</h1>"),innerForm.append("<p>Some text accompanying the node creation box.</p>"),innerForm.append('<input type="text" class="form-control name-box"></input>'),$(".content").after(form),$(window.document).on("keypress",keyPressHandler)},sociogram.getKineticNodes=function(){return nodeLayer.children},sociogram.getKineticEdges=function(){return edgeLayer.children},sociogram.getSimpleNodes=function(){var simpleNodes={},nodes=sociogram.getKineticNodes();return $.each(nodes,function(index,value){simpleNodes[value.attrs.id]={},simpleNodes[value.attrs.id].x=value.attrs.x,simpleNodes[value.attrs.id].y=value.attrs.y,simpleNodes[value.attrs.id].name=value.attrs.name,simpleNodes[value.attrs.id].type=value.attrs.type,simpleNodes[value.attrs.id].size=value.attrs.size,simpleNodes[value.attrs.id].color=value.attrs.color}),simpleNodes},sociogram.getSimpleEdges=function(){var simpleEdges={},edgeCounter=0;return $.each(edgeLayer.children,function(index,value){simpleEdges[edgeCounter]={},simpleEdges[edgeCounter].from=value.attrs.from.attrs.id,simpleEdges[edgeCounter].to=value.attrs.to.attrs.id,edgeCounter++}),simpleEdges},sociogram.getSimpleEdge=function(id){var simpleEdges=sociogram.getSimpleEdges();if(!id)return!1;var simpleEdge=simpleEdges[id];return simpleEdge},sociogram.getEdgeLayer=function(){return edgeLayer},sociogram.getNodeByID=function(id){var node={},nodes=sociogram.getKineticNodes();return $.each(nodes,function(index,value){value.attrs.id===id&&(node=value)}),node},sociogram.getNodeColorByType=function(type){var returnVal=null;return $.each(sociogram.settings.nodeTypes,function(index,value){value.name===type&&(returnVal=value.color)}),returnVal?returnVal:!1},sociogram};module.exports=new Sociogram,window.Storage.prototype.showUsage=function(){var total=0;for(var x in localStorage){var amount=2*localStorage[x].length/1024/1024;total+=amount,console.log(x+" = "+amount.toFixed(2)+" MB")}console.log("Total: "+total.toFixed(2)+" MB")},window.Storage.prototype.setObject=function(key,value){this.setItem(key,JSON.stringify(value))},window.Storage.prototype.getObject=function(key){if(null===this.getItem(key))return!1;var value=this.getItem(key);return value&&JSON.parse(value)},Object.defineProperty(Array.prototype,"remove",{enumerable:!1,value:function(item){for(var removeCounter=0,index=0;index<this.length;index++)this[index]===item&&(this.splice(index,1),removeCounter++,index--);return removeCounter}}),exports.arrayDifference=function(a1,a2){var a2Set=new Set(a2);return a1.filter(function(x){return!a2Set.has(x)})},exports.removeFromObject=function(item,object){console.log("removeFromObject"),console.log(item),console.log(object);for(var removeCounter=0,index=0;index<object.length;index++)object[index]===item&&(object.splice(index,1),removeCounter++,index--);return console.log(object),removeCounter},exports.deepEquals=function(a,x){var p;for(p in a)if("undefined"==typeof x[p])return!1;for(p in a)if(a[p])switch(typeof a[p]){case"object":if(a[p].sort&&(a[p].sort(),x[p].sort()),!deepEquals(a[p],x[p]))return!1;break;case"function":if("undefined"==typeof x[p]||a[p].toString()!==x[p].toString())return!1;break;default:if(a[p]!==x[p])return!1}else if(x[p])return!1;for(p in x)if("undefined"==typeof a[p])return!1;return!0},exports.isInNestedObject=function(targetArray,objectKey,objectKeyValue){for(var i=0;i<targetArray.length;i++)for(var prop in targetArray[i])if(prop===objectKey&&targetArray[i][prop]===objectKeyValue)return!0;return!1},exports.getValueFromNestedObject=function(targetArray,objectKey){for(var i=0;i<targetArray.length;i++)for(var prop in targetArray[i])if(prop===objectKey)return targetArray[i][prop];return!1},exports.extend=function(a,b){for(var key in b)b.hasOwnProperty(key)&&(a[key]=b[key]);return a},exports.notify=function(text,level){level=level||0,level>=global.debugLevel&&console.log(text)},exports.randomBetween=function(min,max){return Math.random()*(max-min)+min},exports.hex=function(x){return("0"+parseInt(x).toString(16)).slice(-2)},$.cssHooks.backgroundColor={get:function(elem){var bg;return elem.currentStyle?bg=elem.currentStyle.backgroundColor:window.getComputedStyle&&(bg=window.document.defaultView.getComputedStyle(elem,null).getPropertyValue("background-color")),-1===bg.search("rgb")?bg:(bg=bg.match(/^rgb\((\d+),\s*(\d+),\s*(\d+)\)$/),"#"+global.tools.hex(bg[1])+global.tools.hex(bg[2])+global.tools.hex(bg[3]))}},exports.modifyColor=function(hex,lum){hex=String(hex).replace(/[^0-9a-f]/gi,""),hex.length<6&&(hex=hex[0]+hex[0]+hex[1]+hex[1]+hex[2]+hex[2]),lum=lum||0;var c,i,rgb="#";for(i=0;3>i;i++)c=parseInt(hex.substr(2*i,2),16),c=Math.round(Math.min(Math.max(0,c+c*lum),255)).toString(16),rgb+=("00"+c).substr(c.length);return rgb};