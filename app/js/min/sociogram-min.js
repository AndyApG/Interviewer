var Kinetic=require("./../bower_components/konva/Konva.js"),Sociogram=function e(){function e(e,t,o){for(;1.1*e.width()<t.width()-2*o;)e.fontSize(1.1*e.fontSize()),e.y((t.height()-e.height())/2);e.setX(t.getX()-e.getWidth()/2),e.setY(t.getY()-e.getHeight()/1.8)}var t,o,i,n,r,d={},a,s=[],l,c=!1,g=!1,w=!1,f={blue:"#0174DF",placidblue:"#83b5dd",violettulip:"#9B90C8",hemlock:"#9eccb3",paloma:"#aab1b0",freesia:"#ffd600",cayenne:"#c40000",celosiaorange:"#f47d44",sand:"#ceb48d",dazzlingblue:"#006bb6",edge:"#e85657",selected:"gold"},m={defaultNodeSize:35,defaultNodeColor:f.blue,defaultEdgeColor:f.edge,concentricCircleColor:"#ffffff",concentricCircleNumber:4,criteria:{from:global.network.getNodes({type_t0:"Ego"})[0].id},nodeTypes:[{name:"Person",color:f.blue},{name:"OnlinePerson",color:f.hemlock},{name:"Organisation",color:f.cayenne},{name:"Professional",color:f.violettulip}]},u=function(e){d.addNode(e.detail)},h=function(e){"undefined"!=typeof e.detail.from&&e.detail.from!==global.network.getNodes({type_t0:"Ego"})[0].id&&d.addEdge(e.detail)},v=function(e){d.removeNode(e.detail)},p=function(e){d.removeEdge(e.detail)},b=function(){var e=$(".info-button").offset(),t=$(".sociogram-title").offset();$(".sociogram-title").data("oldPos",t),$(".sociogram-title").css({position:"absolute"}),$(".sociogram-title").offset(t),$(".sociogram-title").children().hide(),$(".sociogram-title").addClass("closed"),$(".sociogram-title").offset(e),setTimeout(function(){$(".sociogram-popover").hide(),$(".info-button").css("visibility","visible")},500)},y=function(){$(".info-button").css("visibility","hidden"),$(".sociogram-popover").show(),$(".sociogram-title").offset($(".sociogram-title").data("oldPos")),$(".sociogram-title").removeClass("closed"),setTimeout(function(){$(".sociogram-title").children().show()},500)},k=function(e){if(!g&&(c||($(".new-node-form").addClass("node-form-open"),$(".content").addClass("blurry"),c=!0,$(".name-box").focus()),8!==e.which||$(e.target).is("input, textarea, div")||e.preventDefault(),13===event.which)){$(".new-node-form").removeClass("node-form-open"),$(".content").removeClass("blurry"),c=!1;var t={label:$(".name-box").val()};global.network.addNode(t),$(".name-box").val("")}},E=function(){d.destroy()};return d.init=function(e){global.tools.notify("Sociogram initialising.",1),global.tools.extend(m,e),$('<div class="sociogram-title"><h3>'+m.heading+'</h3><p class="lead">'+m.subheading+"</p></div>").insertBefore("#kineticCanvas"),d.initKinetic(),window.addEventListener("nodeAdded",u,!1),window.addEventListener("edgeAdded",h,!1),window.addEventListener("nodeRemoved",v,!1),window.addEventListener("edgeRemoved",p,!1),window.addEventListener("changeStageStart",E,!1),$(".close-popover").on("click",b),$(".info-button").on("click",y);for(var t=global.network.getEdges(m.criteria),o=0;o<t.length;o++){var i=global.network.getEdges({from:t[o].from,to:t[o].to,type:"Dyad"})[0],r=d.addNode(i);if("Select"===m.mode)if(m.variable){var a={from:global.network.getNodes({type_t0:"Ego"})[0].id,to:t[o].to};a[m.variable]=1,global.network.getEdges(a).length>0&&(r.children[0].stroke(f.selected),n.draw())}else global.network.getEdges({from:global.network.getNodes({type_t0:"Ego"})[0].id,to:t[o].to,type:m.edgeType}).length>0&&(r.children[0].stroke(f.selected),n.draw())}setTimeout(function(){d.drawUIComponents()},0);var s,l;"Edge"===m.mode?(l={type:m.edgeType},s=global.network.getEdges(l,function(e){var t=[];return $.each(e,function(e,o){o.from!==global.network.getNodes({type_t0:"Ego"})[0].id&&o.to!==global.network.getNodes({type_t0:"Ego"})[0].id&&t.push(o)}),t}),$.each(s,function(e,t){d.addEdge(t)})):"Select"===m.mode?(l={},l=m.showEdge?{type:m.showEdge}:{type:"Dyad"},s=global.network.getEdges(l,function(e){var t=[];return $.each(e,function(e,o){o.from!==global.network.getNodes({type_t0:"Ego"})[0].id&&o.to!==global.network.getNodes({type_t0:"Ego"})[0].id&&t.push(o)}),t}),$.each(s,function(e,t){d.addEdge(t)})):"Position"===m.mode},d.destroy=function(){console.log("sociogram being destroyed"),$(".new-node-form").remove(),window.removeEventListener("nodeAdded",u,!1),window.removeEventListener("edgeAdded",h,!1),window.removeEventListener("nodeRemoved",v,!1),window.removeEventListener("edgeRemoved",p,!1),window.removeEventListener("changeStageStart",E,!1),$(window.document).off("keypress",k),$(".close-popover").off("click",b),$(".info-button").off("click",y)},d.resetPositions=function(){for(var e=global.network.getEdges({from:global.network.getNodes({type_t0:"Ego"})[0].id,type:"Dyad"}),t=0;t<e.length;t++)global.network.updateEdge(e[t].id,{coords:[]})},d.addNode=function(t){global.tools.notify("Sociogram is creating a node.",2);for(var o,r=0;global.network.getNode(r)!==!1;)r++;var c=!1;("Position"===m.mode||"Edge"===m.mode)&&(c=!0),t.label=t.nname_t0;var g={coords:[$(window).width()+50,100],id:r,label:"Undefined",size:m.defaultNodeSize,color:"rgb(0,0,0)",strokeWidth:4,draggable:c,dragDistance:20};global.tools.extend(g,t),g.id=parseInt(g.id,10),g.type="Person",g.x=g.coords[0],g.y=g.coords[1];var u=new Kinetic.Group(g);switch(g.type){case"Person":o=new Kinetic.Circle({radius:g.size,fill:g.color,stroke:"white",strokeWidth:g.strokeWidth});break;case"Organisation":o=new Kinetic.Rect({width:2*g.size,height:2*g.size,fill:g.color,stroke:d.calculateStrokeColor(g.color),strokeWidth:g.strokeWidth});break;case"OnlinePerson":o=new Kinetic.RegularPolygon({sides:3,fill:g.color,radius:1.2*g.size,stroke:d.calculateStrokeColor(g.color),strokeWidth:g.strokeWidth});break;case"Professional":o=new Kinetic.Star({numPoints:6,fill:g.color,innerRadius:g.size-g.size/3,outerRadius:g.size+g.size/3,stroke:d.calculateStrokeColor(g.color),strokeWidth:g.strokeWidth})}var h=new Kinetic.Text({text:g.label,fontFamily:"Lato",fill:"white",align:"center",fontStyle:500});if(global.tools.notify("Putting node "+g.label+" at coordinates x:"+g.coords[0]+", y:"+g.coords[1],2),u.on("dragstart",function(){if(w===!1){var e={stage:global.session.currentStage(),timestamp:new Date};l=new window.CustomEvent("log",{detail:{eventType:"taskComprehended",eventObject:e}}),window.dispatchEvent(l),w=!0}global.tools.notify("dragstart",1),this.attrs.oldx=this.attrs.x,this.attrs.oldy=this.attrs.y,this.moveToTop(),n.draw()}),u.on("dragmove",function(){if(w===!1){var e={stage:global.session.currentStage(),timestamp:new Date};l=new window.CustomEvent("log",{detail:{eventType:"taskComprehended",eventObject:e}}),window.dispatchEvent(l),w=!0}global.tools.notify("Dragmove",0);var t=g.id;$.each(i.children,function(e,o){if(o.attrs.from.id===t||o.attrs.to.id===t){var i=[d.getNodeByID(o.attrs.from.id).getX(),d.getNodeByID(o.attrs.from.id).getY(),d.getNodeByID(o.attrs.to.id).getX(),d.getNodeByID(o.attrs.to.id).getY()];o.attrs.points=i}}),i.draw()}),u.on("tap click",function(){if(w===!1){var e={stage:global.session.currentStage(),timestamp:new Date};l=new window.CustomEvent("log",{detail:{eventType:"taskComprehended",eventObject:e}}),window.dispatchEvent(l),w=!0}l=new window.CustomEvent("log",{detail:{eventType:"nodeClick",eventObject:this.attrs.id}});var t=this;if(window.dispatchEvent(l),"Select"===m.mode){var o;if(m.variable){var i={},r=global.network.getEdge(t.attrs.id)[m.variable];0===r||"undefined"==typeof r?(i[m.variable]=1,t.children[0].stroke(f.selected)):(i[m.variable]=0,t.children[0].stroke("white")),global.network.setProperties(global.network.getEdge(t.attrs.id),i)}else global.network.getEdges({type:m.edgeType,from:global.network.getNodes({type_t0:"Ego"})[0].id,to:this.attrs.to}).length>0?(this.children[0].stroke("white"),global.network.removeEdge(global.network.getEdges({type:m.edgeType,from:global.network.getNodes({type_t0:"Ego"})[0].id,to:this.attrs.to})[0])):(o={from:global.network.getNodes({type_t0:"Ego"})[0].id,to:this.attrs.to,type:m.edgeType},"undefined"!=typeof m.variables&&$.each(m.variables,function(e,t){o[t.label]=t.value}),this.children[0].stroke(f.selected),global.network.addEdge(o))}else if("Edge"===m.mode){if(s[0]===this)return!1;if(s.push(this),2===s.length){s[1].children[0].stroke("white"),s[0].children[0].stroke("white");var d={from:s[0].attrs.to,to:s[1].attrs.to,type:m.edgeType};d[m.variables[0]]="perceived",global.network.addEdge(d)===!1&&(global.tools.notify("Sociogram removing edge.",2),global.network.removeEdge(global.network.getEdges(d))),s=[],n.draw()}else this.children[0].stroke(f.selected),n.draw()}this.moveToTop(),n.draw()}),u.on("dbltap dblclick",function(){if(w===!1){var e={stage:global.session.currentStage(),timestamp:new Date};l=new window.CustomEvent("log",{detail:{eventType:"taskComprehended",eventObject:e}}),window.dispatchEvent(l),w=!0}"Edge"===m.mode&&(global.tools.notify("double tap",1),a=this)}),u.on("dragend",function(){global.tools.notify("dragend",1);var e={},t={};e.x=this.attrs.oldx,e.y=this.attrs.oldy,t.x=this.attrs.x,t.y=this.attrs.y;var o={from:e,to:t},i=this;l=new window.CustomEvent("log",{detail:{eventType:"nodeMove",eventObject:o}}),window.dispatchEvent(l),global.network.setProperties(global.network.getEdge(i.attrs.id),{coords:[i.attrs.x,i.attrs.y]}),delete this.attrs.oldx,delete this.attrs.oldy}),e(h,o,10),u.add(o),u.add(h),n.add(u),setTimeout(function(){n.draw()},0),!t.coords||0===t.coords.length){var v=new Kinetic.Tween({node:u,x:$(window).width()-150,y:100,duration:.7,easing:Kinetic.Easings.EaseOut});v.play(),global.network.setProperties(global.network.getNode(g.id),{coords:[$(window).width()-150,100]})}return u},d.addEdge=function(e){global.tools.notify("Sociogram is adding an edge.",2);var t=global.network.getEdges({from:global.network.getNodes({type_t0:"Ego"})[0].id,to:e.to,type:"Dyad"})[0],o=global.network.getEdges({from:global.network.getNodes({type_t0:"Ego"})[0].id,to:e.from,type:"Dyad"})[0],r=[o.coords[0],o.coords[1],t.coords[0],t.coords[1]],d=new Kinetic.Line({strokeWidth:4,opacity:1,stroke:m.defaultEdgeColor,from:o,to:t,points:r});return i.add(d),setTimeout(function(){i.draw()},0),n.draw(),global.tools.notify("Created Edge between "+o.label+" and "+t.label,"success",2),!0},d.removeEdge=function(e){var t=global.network.getEdges({from:global.network.getNodes({type_t0:"Ego"})[0].id,to:e.to,type:"Dyad"})[0],o=global.network.getEdges({from:global.network.getNodes({type_t0:"Ego"})[0].id,to:e.from,type:"Dyad"})[0];global.tools.notify("Removing edge."),$.each(d.getKineticEdges(),function(e,n){void 0!==n&&(n.attrs.from===o&&n.attrs.to===t||n.attrs.from===t&&n.attrs.to===o)&&(i.children[e].remove(),i.draw())})},d.clearGraph=function(){i.removeChildren(),i.clear(),n.removeChildren(),n.clear()},d.initKinetic=function(){t=new Kinetic.Stage({container:"kineticCanvas",width:window.innerWidth,height:window.innerHeight}),o=new Kinetic.Layer,n=new Kinetic.Layer,i=new Kinetic.Layer,r=new Kinetic.Layer,t.add(o),t.add(i),t.add(n),t.add(r),global.tools.notify("Kinetic stage initialised.",1)},d.drawUIComponents=function(){for(var e,t,i=m.concentricCircleColor,n=window.innerHeight-m.defaultNodeSize,d=.1,a=0;a<m.concentricCircleNumber;a++){var s=1-a/m.concentricCircleNumber,l=n/2*s;t=new Kinetic.Circle({x:window.innerWidth/2,y:window.innerHeight/2,radius:l,stroke:"white",strokeWidth:1.5,opacity:0}),e=new Kinetic.Circle({x:window.innerWidth/2,y:window.innerHeight/2,radius:l,fill:i,opacity:d,strokeWidth:0}),d+=(.3-d)/m.concentricCircleNumber,o.add(e),o.add(t)}o.draw(),r.draw(),global.tools.notify("User interface initialised.",1)},d.initNewNodeForm=function(){var e=$('<div class="new-node-form"></div>'),t=$('<div class="new-node-inner"></div>');e.append(t),t.append("<h1>Add a new contact</h1>"),t.append("<p>Some text accompanying the node creation box.</p>"),t.append('<input type="text" class="form-control name-box"></input>'),$(".content").after(e),$(window.document).on("keypress",k)},d.getKineticNodes=function(){return n.children},d.getKineticEdges=function(){return i.children},d.getSimpleNodes=function(){var e={},t=d.getKineticNodes();return $.each(t,function(t,o){e[o.attrs.id]={},e[o.attrs.id].x=o.attrs.x,e[o.attrs.id].y=o.attrs.y,e[o.attrs.id].name=o.attrs.name,e[o.attrs.id].type=o.attrs.type,e[o.attrs.id].size=o.attrs.size,e[o.attrs.id].color=o.attrs.color}),e},d.getSimpleEdges=function(){var e={},t=0;return $.each(i.children,function(o,i){e[t]={},e[t].from=i.attrs.from.attrs.id,e[t].to=i.attrs.to.attrs.id,t++}),e},d.getSimpleEdge=function(e){var t=d.getSimpleEdges();if(!e)return!1;var o=t[e];return o},d.getEdgeLayer=function(){return i},d.getNodeByID=function(e){var t={},o=d.getKineticNodes();return $.each(o,function(o,i){i.attrs.id===e&&(t=i)}),t},d.getNodeColorByType=function(e){var t=null;return $.each(m.nodeTypes,function(o,i){i.name===e&&(t=i.color)}),t?t:!1},d};module.exports=new Sociogram;