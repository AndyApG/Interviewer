var Session=function e(){function e(e){var t=JSON.stringify(n.userData,void 0,2);fs.writeFile(e,t)}function t(){$("#save").prop("nwsaveas",n.returnSessionID()+"_"+Math.floor(Date.now()/1e3)+".json");var e=document.createEvent("MouseEvents");e.initMouseEvent("click"),document.getElementById("save").dispatchEvent(e)}var n={},o=0,a=$("#content"),s={};n.id=0,n.userData={};var i,r;return n.options={fnBeforeStageChange:function(e,t){var n={stage:o,timestamp:new Date},a=new window.CustomEvent("log",{detail:{eventType:"stageCompleted",eventObject:n}});window.dispatchEvent(a);var s=new window.CustomEvent("changeStageStart",{detail:{oldStage:e,newStage:t}});window.dispatchEvent(s)},fnAfterStageChange:function(e,t){var n=new window.CustomEvent("changeStageEnd",{detail:{oldStage:e,newStage:t}});window.dispatchEvent(n)}},n.init=function(){global.tools.notify("Session initialising.",1);var o=require("path"),a=o.normalize("../protocols/"+global.studyProtocol+"/"+global.studyProtocol+".netcanvas"),i=require(a);n.stages=i.stages,n.name=i.parameters.name,window.addEventListener("changeStageStart",function(){$(".loader").transition({opacity:1})},!1),window.addEventListener("changeStageEnd",function(){$(".loader").transition({opacity:0})},!1),window.document.getElementById("save").addEventListener("change",function(){e(this.value)}),global.dataStore.init(function(e){n.id=e,global.dataStore.load(function(e){n.updateUserData(e),n.goToStage(0)},n.id)}),n.registerData("session"),window.addEventListener("unsavedChanges",function(){n.saveManager()},!1);var r=global.menu.addMenu("Session","hi-icon-cog");menu.addItem(r,"Reset Session","icon-globe",function(){window.BootstrapDialog.show({type:window.BootstrapDialog.TYPE_INFO,title:"Are you sure?",message:"<h4>Are you sure you want to reset the session?</h4> <p><strong>IMPORTANT: This will delete any data you have already entered.</strong>",buttons:[{label:"Continue",cssClass:"btn-success",action:function(){n.reset()}},{icon:"glyphicon glyphicon-ban-circle",label:"Cancel",cssClass:"btn-warning",action:function(e){e.close()}}]})}),menu.addItem(r,"Download Data","icon-briefcase",function(){t()}),menu.addItem(r,"Purge Database","icon-cloud",function(){window.BootstrapDialog.show({type:window.BootstrapDialog.TYPE_INFO,title:"Are you sure?",message:"<h4>Are you sure you want to purge the database?</h4> <p><strong>IMPORTANT: This will delete any data you have already entered.</strong>",buttons:[{label:"Continue",cssClass:"btn-success",action:function(){s.reset(n.reset)}},{icon:"glyphicon glyphicon-ban-circle",label:"Cancel",cssClass:"btn-warning",action:function(e){e.close()}}]})});var l=menu.addMenu("Stages","hi-icon-list");$.each(n.stages,function(e,t){global.menu.addItem(l,t.label,"icon-play",function(){setTimeout(function(){n.goToStage(e)},500)})})},n.downloadData=function(){var e=n.returnSessionID()+".json",t=JSON.stringify(n.userData,void 0,2),o=document.createElement("a");o.setAttribute("href","data:text/plain;charset=utf-8,"+encodeURIComponent(t)),o.setAttribute("download",e),o.click()},n.reset=function(){global.tools.notify("Resetting session.",2),localStorage.removeItem("activeSession"),localStorage.removeItem("nodes"),localStorage.removeItem("edges"),localStorage.removeItem("session"),localStorage.removeItem("log"),n.id=0,n.currentStage=0,location.reload()},n.saveManager=function(){clearTimeout(r),r=setTimeout(n.saveData,3e3)},n.updateUserData=function(e){global.tools.notify("Updating user data.",2),global.tools.notify("Using the following to update:",1),global.tools.notify(e,1),global.tools.notify("session.userData is:",1),global.tools.notify(n.userData,1),global.tools.extend(n.userData,e),global.tools.notify("Combined output is:",0),global.tools.notify(n.userData,0);var t=new window.Event("newDataLoaded");window.dispatchEvent(t);var o=new window.Event("unsavedChanges");window.dispatchEvent(o)},n.returnSessionID=function(){return n.id},n.saveData=function(){global.dataStore.save(n.userData,n.returnSessionID()),i=new Date},n.goToStage=function(e){if("undefined"==typeof e||"undefined"==typeof n.stages[e])return!1;if(n.stages[e].skip){var t=n.stages[e].skip();if(t===!0)return console.log("Skipping because skip condition was met."),n.goToStage(e>o?e+1:e-1),!1}global.tools.notify("Session is moving to stage "+e,3);var s={stage:e,timestamp:new Date},i=new window.CustomEvent("log",{detail:{eventType:"stageVisible",eventObject:s}});window.dispatchEvent(i),n.options.fnBeforeStageChange(o,e);var r=e,l="./protocols/"+global.studyProtocol+"/stages/"+n.stages[e].page;a.transition({opacity:"0"},400,"easeInSine").promise().done(function(){a.load(l,function(){a.transition({opacity:"1"},400,"easeInSine")})});var d=o;o=r,n.options.fnAfterStageChange(d,o);var u=new window.Event("unsavedChanges");window.dispatchEvent(u)},n.nextStage=function(){n.goToStage(o+1)},n.prevStage=function(){n.goToStage(o-1)},n.registerData=function(e,t){global.tools.notify('A script requested a data store be registered with the key "'+e+'".',2),void 0===n.userData[e]?(global.tools.notify('Key named "'+e+'" was not already registered. Creating.',1),n.userData[e]=t?[]:{}):global.tools.notify("A data store with this key already existed. Returning a pointer.",1);var o=new window.Event("unsavedChanges");return window.dispatchEvent(o),n.userData[e]},n.addData=function(e,t,o){o||(o=!1),o===!0?n.userData[e].push(t):global.tools.extend(n.userData[e],t),global.tools.notify("Adding data to key '"+e+"'.",2),global.tools.notify(t,1);var a=new window.Event("unsavedChanges");window.dispatchEvent(a)},n.currentStage=function(){return o},n.returnData=function(e){return e&&"undefined"!=typeof n.userData[e]?n.userData[e]:n.userData},n};module.exports=new Session;